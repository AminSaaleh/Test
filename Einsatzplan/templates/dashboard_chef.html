<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Chef Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .fc-daygrid-event-dot{
      height:16px;width:16px;border-radius:50%;
      background-color:currentColor !important;
      margin-right:6px;
      border:0 !important;
    }
    /* Chef: abgelehnt oder entfernt bleibt rot */
#response-list.requests-grid > li.abgelehnt_chef,
#response-list.requests-grid > li.entfernt_chef {
  background: #fdecea;
  border-color: #c62828;
}
    /* Wochenende grau (Sa/So) â€“ stÃ¤rker/gezielter, damit es in Chef-Ansicht sicher greift */
    #calendar .fc-daygrid-day.weekend,
    #planning-calendar .fc-daygrid-day.weekend{
      background:#f2f2f2 !important;
    }
    .fc-event-title{font-weight:bold;font-size:14px;}

    .detail-box{border:1px solid #ddd;border-radius:6px;padding:8px;margin-bottom:10px;background:#fafafa;}
    .filter-row{margin:10px 0;}
    #response-list button.inline{margin-left:8px;padding:2px 8px;font-size:12px;}
    .section{margin-top:12px;padding-top:8px;border-top:1px dashed #ddd;}
    .tfoot-sum td{font-weight:bold;border-top:2px solid #ccc;}
    .hint{font-size:12px;color:#666;margin-top:6px;}
    .form-row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
    .form-row > *{flex:1;min-width:160px;}
    /* âœ… Checkbox + Text sollen eng beieinander stehen (keine 100%-Breite aus globalem CSS Ã¼bernehmen) */
    .checkbox-row{display:flex;align-items:center;justify-content:flex-start;gap:8px;margin:10px 0;flex-wrap:nowrap;width:auto;}
    .checkbox-row input[type="checkbox"]{margin:0;width:auto !important;flex:0 0 auto;display:inline-block;}
    .checkbox-row label{margin:0;white-space:nowrap;width:auto !important;flex:0 1 auto;display:inline-block;}
    .muted{color:#666;font-size:12px;}
  
    /* âœ… Anfragen im Einsatzdetails: 4 nebeneinander (Grid) */
    #response-list.requests-grid{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    /* Karten-Look fÃ¼r EintrÃ¤ge */
    #response-list.requests-grid > li{
      border:1px solid #ddd;
      border-radius:8px;
      padding:10px;
      background:#fff;
    }
    /* âœ… Status-Farben auf der ganzen Kachel */
    #response-list.requests-grid > li.bestÃ¤tigt{
      background:#e6f6ea;           /* grÃ¼n */
      border-color:#2e7d32;
    }
    #response-list.requests-grid > li.abgelehnt{
      background:#fdecea;           /* rot */
      border-color:#c62828;
    }
    /* âœ… Chef-Ablehnung/Entfernen auch rot (damit es in Einsatzdetails rot bleibt) */
    #response-list.requests-grid > li.abgelehnt_chef,
    #response-list.requests-grid > li.entfernt_chef{
      background:#fdecea;
      border-color:#c62828;
    }
    /* Buttons in der Karte: sauber umbrechen */
    #response-list.requests-grid button.inline{
      margin-left:0;
      margin-top:8px;
      margin-right:8px;
    }
    @media (max-width: 1200px){
      #response-list.requests-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 650px){
      #response-list.requests-grid{ grid-template-columns: 1fr; }
    }

    /* ===== Planung: sachlich & kompakt (Titel + bestÃ¤tigte Namen) ===== */
    #planning-calendar .fc-daygrid-event{
      background: transparent !important;   /* kein blau */
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      padding: 2px 4px !important;
      box-shadow: none !important;
      cursor: default !important;
      white-space: normal;
    }
    #planning-calendar .fc-daygrid-event .fc-event-main{ color: inherit !important; }
    #planning-calendar .plan-title{
      font-size: 16px;
      font-weight: 1000; /* Titel fett */
      line-height: 1.2;
      color: #111;
    }
    #planning-calendar .plan-staff{
      font-size: 13px;
      line-height: 1.2;
      color: #333;
      margin-top: 1px;
    }
    #planning-calendar .plan-staff-row{display:block;padding:2px 4px;border-radius:4px;}
    #planning-calendar .plan-staff-row.done{background:#e6f6ea;border:1px solid #2e7d32;}
    #planning-calendar .plan-staff-times{color:#555;}



  

    /* âœ… verhindert FullCalendar-Standard-Blau in Planung (auch nach Tab-Wechsel) */
    #planning-calendar .fc-h-event,
    #planning-calendar .fc-daygrid-event-harness .fc-event,
    #planning-calendar .fc-daygrid-event .fc-event-main-frame{
      background: transparent !important;
    }


/* âœ… Einheitlicher Tabellen-Abstand (Report & ZÃ¤hler) */
.user-table {
  border-collapse: collapse;
  width: 100%;
}

.user-table th,
.user-table td {
  padding: 8px 10px;
  vertical-align: middle;
  text-align: center;
  line-height: 1.4;
}

/* Erste Spalte (Name) linksbÃ¼ndig */
.user-table th:first-child,
.user-table td:first-child {
  text-align: left;
  white-space: nowrap;
}

/* Kopfzeile kompakter */
.user-table thead th {
  padding-top: 6px;
  padding-bottom: 6px;
}

/* Summenzeile absetzen */
.user-table tfoot .tfoot-sum td {
  padding-top: 10px;
  padding-bottom: 10px;
  background: #f7f7f7;
}

</style>

<style>
/* === Voll gefÃ¼llte Status-Kreise === */
.fc-daygrid-event-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none !important;
    margin-right: 4px;
}

.status-bestaetigt .fc-daygrid-event-dot {
    background-color: #2ecc71 !important;
}

.status-offen .fc-daygrid-event-dot {
    background-color: #f1c40f !important;
}

.status-abgelehnt .fc-daygrid-event-dot {
    background-color: #e74c3c !important;
}

.status-ersatz .fc-daygrid-event-dot {
    background-color: #3498db !important;
}

.status-zugesagt .fc-daygrid-event-dot {
    background-color: #f39c12 !important; /* orange */
}

.status-abgelehnt_chef .fc-daygrid-event-dot,
.status-entfernt_chef .fc-daygrid-event-dot {
    background-color: #e74c3c !important; /* rot */
}
</style>

<style>
/* === OVERRIDE: Chef-Statuskreise (FINAL) === */
#calendar .fc-daygrid-event-dot{
  background-color:#b0b0b0 !important;
}

/* ğŸ”µ Bewerbungen vorhanden */
#calendar .status-event-bewerbung .fc-daygrid-event-dot{
  background-color:#1e90ff !important;
}

/* ğŸŸ¢ Mitarbeiteranzahl erreicht */
#calendar .status-event-voll .fc-daygrid-event-dot{
  background-color:#2ecc71 !important;
}
</style>

<style>
/* âœ… ErgÃ¤nzung: Samstag & Sonntag grau fÃ¤rben (Spalten) */
.fc-day-sat, .fc-day-sun {
  background-color: #f2f2f2 !important;
}
</style>


<style>
/* âœ… Responsive: In Planung Zeiten unter Namen bei kleinem Bildschirm
   + verhindert Umbruch innerhalb der Zeitspanne (09:00â€“22:00 bleibt zusammen) */
@media (max-width: 600px) {
  #planning-calendar .plan-staff-row{
    display: block;
  }

  #planning-calendar .plan-staff-times{
    display: block;
    margin-left: 0;
    font-size: 12px;
    color: #555;
    white-space: nowrap;          /* âœ… Startâ€“Ende bleibt in einer Zeile */
    overflow: hidden;             /* optional: falls extrem schmal */
    text-overflow: ellipsis;      /* optional */
  }
}
</style>


<style>
/* === Planner: grÃ¶ÃŸere Schrift & mehr Luft === */
#planning-calendar .plan-title {
  font-size: 18px;
  font-weight: 800;
  line-height: 1.3;
}

#planning-calendar .plan-staff {
  font-size: 15px;
  line-height: 1.4;
}

#planning-calendar .plan-staff-row {
  padding: 4px 6px;
}

#planning-calendar .plan-staff-times {
  font-size: 14px;
}

#planning-calendar .fc-daygrid-day-frame {
  padding: 6px;
}
</style>

</head>
<body>
  <nav>
    <div class="left">
      {% set _role = role|default("chef") %}
{% if _role == "planer" %}
      <a href="#" id="tab-planning" class="active">ğŸ—‚ï¸ Planung</a>
{% else %}
      <a href="#" id="tab-calendar" class="active">ğŸ“… Kalender</a>
            <a href="#" id="tab-termine">ğŸ—“ï¸ Meine Termine</a>
<a href="#" id="tab-planning">ğŸ—‚ï¸ Planung</a>
      <a href="#" id="tab-users">ğŸ‘¥ Personal</a>
      <a href="#" id="tab-report">ğŸ“Š Report</a>
      <a href="#" id="tab-counter">ğŸ§® ZÃ¤hler</a>
{% endif %}
    </div>
    <div class="right">
      <span>{{ user }}</span>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <!-- Kalender -->
  <div id="calendar"></div>

  <!-- Meine Termine (Chef) -->
  <div id="termine" style="display:none;">
    <h3 style="margin-top:10px;">ğŸ—“ï¸ Meine bestÃ¤tigten Termine</h3>

    <div class="filter-row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div style="display:flex;gap:8px;align-items:center;">
        <label for="termine-month"><b>Monat:</b></label>
        <select id="termine-month">
          <option value="1">Januar</option><option value="2">Februar</option><option value="3">MÃ¤rz</option>
          <option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">August</option><option value="9">September</option>
          <option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <label for="termine-year"><b>Jahr:</b></label>
        <input type="number" id="termine-year" min="2020" max="2100" step="1" style="max-width:120px;">
      </div>
    </div>

    <div class="muted" id="termine-count">0 Termine</div>

    <table class="user-table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Titel</th>
          <th>Ort</th>
          <th>Start</th>
          <th>Vorauss. Ende</th>
          <th>Bemerkung</th>
        </tr>
      </thead>
      <tbody id="termine-list"></tbody>
    </table>
  </div>

  <!-- Planung -->
  <div id="planning" style="display:none;">
    <div id="planning-calendar"></div>
  </div>

  <!-- Report -->
  <div id="report" style="display:none;">
    <h3>Arbeitszeiten des Personals</h3>
    <div class="filter-row">
      <label for="report-year">Jahr wÃ¤hlen:</label>
      <input type="number" id="report-year" min="2020" max="2100" step="1">
    </div>

    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Januar</th>
        <th>Februar</th>
        <th>MÃ¤rz</th>
        <th>April</th>
        <th>Mai</th>
        <th>Juni</th>
        <th>Juli</th>
        <th>August</th>
        <th>September</th>
        <th>Oktober</th>
        <th>November</th>
        <th>Dezember</th>
          <th>Gesamt-Stunden</th>
          <th>Gesamt-Kosten</th>
        </tr>
      </thead>
      <tbody id="report-list"></tbody>
      <tfoot>
        <tr class="tfoot-sum" id="report-sum-row">
          <td><b>Summe</b></td>
          <td id="rpt-sum-jan">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-feb">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-mar">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-apr">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-mai">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-jun">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-jul">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-aug">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-sep">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-okt">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-nov">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-dez">0,00 h<br>0,00 â‚¬</td>
          <td id="rpt-sum-hours"><b>0,00 h</b></td>
          <td id="rpt-sum-cost"><b>0,00 â‚¬</b></td>
        </tr>
      </tfoot>
    </table>
    <div class="hint">Doppelklick auf einen Monat Ã¶ffnet die EinsÃ¤tze fÃ¼r diesen Monat.</div>
  </div>


  <!-- ZÃ¤hler -->
  <div id="counter" style="display:none;">
    <h3>ZÃ¤hler â€“ EinsÃ¤tze pro Mitarbeiter</h3>
    <div class="filter-row">
      <label for="counter-year">Jahr wÃ¤hlen:</label>
      <input type="number" id="counter-year" min="2020" max="2100" step="1">
    </div>

    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Januar</th><th>Februar</th><th>MÃ¤rz</th><th>April</th><th>Mai</th><th>Juni</th>
          <th>Juli</th><th>August</th><th>September</th><th>Oktober</th><th>November</th><th>Dezember</th>
          <th>Gesamt (Jahr)</th>
        </tr>
      </thead>
      <tbody id="counter-list"></tbody>

    <tfoot>
      <tr class="tfoot-sum" id="counter-sum-row">
        <td><b>Summe</b></td>
        <td id="sum-jan">0</td>
        <td id="sum-feb">0</td>
        <td id="sum-mar">0</td>
        <td id="sum-apr">0</td>
        <td id="sum-mai">0</td>
        <td id="sum-jun">0</td>
        <td id="sum-jul">0</td>
        <td id="sum-aug">0</td>
        <td id="sum-sep">0</td>
        <td id="sum-okt">0</td>
        <td id="sum-nov">0</td>
        <td id="sum-dez">0</td>
        <td id="sum-year">0</td>
      </tr>
    </tfoot>
    </table>
    <div class="hint">GezÃ¤hlt werden bestÃ¤tigte EinsÃ¤tze (Status â€bestÃ¤tigtâ€œ) je Mitarbeiter.</div>
  </div>


  <!-- Mitarbeiter Verwaltung -->

  <div id="user-management" style="display:none;">
    <h3>Personal verwalten</h3>

    <form id="add-user-form" class="user-form">
      <div class="form-row">
        <input type="text" id="vorname" placeholder="Vorname" required>
        <input type="text" id="nachname" placeholder="Nachname" required>
      </div>

      <div class="form-row">
        <input type="text" id="new-username" placeholder="Benutzername" required>
        <input type="password" id="new-password" placeholder="Passwort" required>
      </div>

      <div class="form-row">
        <select id="new-role">
          <option value="mitarbeiter">Mitarbeiter</option>
          <option value="vorgesetzter">Vorgesetzter</option>
          <option value="planer">Planer</option>
        </select>

        <select id="s34a">
          <option value="nein">34a: Nein</option>
          <option value="ja">34a: Ja</option>
        </select>

        <select id="s34a_art">
          <option value="">-- Art auswÃ¤hlen --</option>
          <option value="unterrichtung">Unterrichtung</option>
          <option value="sachkunde">Sachkunde</option>
        </select>
      </div>

      <div class="form-row">
        <input type="text" id="bewach_id" placeholder="Bewach-ID" required>
        <input type="text" id="steuernummer" placeholder="Steuernummer" required>
      </div>

      <div class="form-row">
        <select id="bsw">
          <option value="nein">BSW: Nein</option>
          <option value="ja">BSW: Ja</option>
        </select>

        <select id="sanitaeter">
          <option value="nein">SanitÃ¤ter: Nein</option>
          <option value="ja">SanitÃ¤ter: Ja</option>
        </select>

        <select id="pschein">
          <option value="nein">P-Schein: Nein</option>
          <option value="ja">P-Schein: Ja</option>
        </select>

        <input type="number" id="stundensatz" step="0.01" min="0" placeholder="Stundensatz (â‚¬/h) optional">
      </div>

      <button type="submit" class="confirm">â• HinzufÃ¼gen</button>
    </form>

    <h4>Personalliste</h4>
    <table class="user-table">
      <thead>
        <tr>
          <th>Benutzername</th>
          <th>Name</th>
          <th>34a</th>
          <th>Bewach-ID</th>
          <th>Steuernummer</th>
          <th>BSW</th>
          <th>SanitÃ¤ter</th>
          <th>P-Schein</th>
          <th>Stundensatz</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="user-list"></tbody>
    </table>
  </div>

  <!-- Modal Einsatz anlegen -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeEventModal()">Ã—</span>
      <h3>Neuen Einsatz anlegen</h3>

      <label>Titel</label>
      <input id="title" placeholder="Titel des Einsatzes">

      <label>Ort</label>
      <input id="ort" placeholder="Ort">

      <label>Dienstkleidung</label>
      <input id="dienst" placeholder="Dienstkleidung">

      <label>Mitteilung</label>
      <input id="auftrag" placeholder="Mitteilung">

      <div class="form-row">
        <div>
          <label>Startzeit</label>
          <input id="start-time" type="time" value="09:00">
        </div>
        <div>
          <label>Voraussichtliche Endzeit</label>
          <input id="planned-end-time" type="time" value="17:00">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Frist (Annahme bis)</label>
          <input id="frist" type="datetime-local">
        </div>
      </div>

      <label>BenÃ¶tigte Mitarbeiter</label>
      <input id="required-staff" type="number" min="1" value="1">

      <div class="checkbox-row">
        <input type="checkbox" id="use-event-rate" checked onchange="toggleEventRateInputs('create')">
        <label for="use-event-rate"><b>Stundensatz pro Einsatz festlegen</b></label>
      </div>

      <label>Stundensatz (â‚¬/h) â€“ nur wenn oben aktiv</label>
      <input id="event-rate" type="number" step="0.01" min="0" placeholder="z.B. 20.00">

      <div class="modal-actions">
        <button class="release" onclick="saveEvent('geplant')">ğŸ“„ Nur planen</button>
        <button class="confirm" onclick="saveEvent('offen')">ğŸš€ Direkt freigeben</button>
      </div>
      <div class="hint">Tipp: Doppelklick auf einen Tag erstellt einen Einsatz.</div>
    </div>
  </div>

  <!-- Modal Einsatzdetails -->
  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeDetailsModal()">Ã—</span>
      <h3>Einsatzdetails</h3>

      <div class="detail-box"><b>Titel:</b> <span id="d-title"></span></div>
      <div class="detail-box"><b>Ort:</b> <span id="d-ort"></span></div>
      <div class="detail-box"><b>Dienstkleidung:</b> <span id="d-dienst"></span></div>
      <div class="detail-box"><b>Mitteilung:</b> <span id="d-auftrag"></span></div>

      <!-- âœ… nur Uhrzeit (keine Datum-Anzeige) -->
      <div class="detail-box"><b>Start (Uhrzeit):</b> <span id="d-start"></span></div>

      <div class="detail-box"><b>Vorauss. Ende:</b> <span id="d-planned-end"></span></div>
      <div class="detail-box"><b>Frist:</b> <span id="d-frist"></span></div>
      <div class="detail-box"><b>BenÃ¶tigt:</b> <span id="d-required"></span></div>
      <div class="detail-box"><b>Abrechnung:</b> <span id="d-rate-mode"></span></div>

      <div class="modal-actions"></div>

      <h4 id="confirmed-counter" title="">BestÃ¤tigt: 0</h4>
      <ul id="response-list" class="requests-grid"></ul>

      <div class="section">
        <h4>Ersatz einsetzen</h4>
        <div class="form-row">
          <select id="replacement-user"></select>
          <button class="confirm" onclick="assignReplacement()">â• Zuweisen</button>
        </div>
      </div>

      <!-- Zeiten pro Mitarbeiter -->
      <div class="section" id="per-user-time-section" style="display:none;">
        <h4>Zeiten pro Mitarbeiter anpassen</h4>

        <div class="form-row">
          <select id="time-user-select"></select>
          <button class="confirm" type="button" onclick="prepareTimeEdit()">ğŸ•’ Zeiten anpassen</button>
        </div>

        <div id="time-edit-box" style="display:none;">
          <div class="form-row">
            <div>
              <label>Startzeit (optional)</label>
              <input type="time" id="time-start">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Bemerkung (optional â€“ sieht der Mitarbeiter)</label>
              <input type="text" id="time-remark" placeholder="z.B. Start wurde angepasst, bitte 10 Min frÃ¼her da sein">
            </div>
          </div>
<div class="form-row" style="margin-top:8px;">
            <button class="confirm" type="button" onclick="saveSelectedUserTimes()">ğŸ’¾ Speichern</button>
            <button class="reject" type="button" onclick="cancelTimeEdit()">Abbrechen</button>
          </div>

          <div class="muted" style="margin-top:6px;">
            Hinweis: Das Ã¤ndert nur die Startzeit beim Mitarbeiter (Response) â€“ nicht den Einsatz-Start im Kalender.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Einsatz bearbeiten -->
  <div class="modal" id="editEventModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeEditEventModal()">Ã—</span>
      <h3>Einsatz bearbeiten</h3>

      <input type="hidden" id="edit-event-id">

      <label>Titel</label>
      <input id="edit-ev-title" placeholder="Titel">

      <label>Ort</label>
      <input id="edit-ev-ort" placeholder="Ort">

      <label>Dienstkleidung</label>
      <input id="edit-ev-dienst" placeholder="Dienstkleidung">

      <label>Mitteilung</label>
      <input id="edit-ev-auftrag" placeholder="Mitteilung">

      <label>Start (Datum & Uhrzeit)</label>
      <input id="edit-ev-start" type="datetime-local">

      
      <label>Voraussichtliche Endzeit</label>
      <input id="edit-ev-planned-end" type="time">
      <div class="form-row">
        <div>
          <label>Frist (Annahme bis)</label>
          <input id="edit-ev-frist" type="datetime-local">
        </div>
        <div>
          <label>Status</label>
          <select id="edit-ev-status">
            <option value="geplant">geplant</option>
            <option value="offen">offen</option>
          </select>
        </div>
      </div>

      <label>BenÃ¶tigte Mitarbeiter</label>
      <input id="edit-ev-required" type="number" min="0" value="0">

      <div class="checkbox-row">
        <input type="checkbox" id="edit-use-event-rate" onchange="toggleEventRateInputs('edit')">
        <label for="edit-use-event-rate"><b>Stundensatz pro Einsatz festlegen</b> (sonst: Mitarbeiter-StundensÃ¤tze)</label>
      </div>

      <label>Stundensatz (â‚¬/h) â€“ nur wenn oben aktiv</label>
      <input id="edit-ev-rate" type="number" step="0.01" min="0">

      <div class="modal-actions">
        <button class="confirm" onclick="saveEventEdit()">ğŸ’¾ Speichern</button>
      </div>
    </div>
  </div>

  <!-- Modal Benutzer bearbeiten -->
  <div class="modal" id="editUserModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeEditModal()">Ã—</span>
      <h3>Mitarbeiter bearbeiten</h3>

      <label>Benutzername</label>
      <input type="text" id="edit-username">

      <label>Vorname</label>
      <input type="text" id="edit-vorname">

      <label>Nachname</label>
      <input type="text" id="edit-nachname">

      <label>Passwort</label>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="password" id="edit-password">
        <button type="button" onclick="togglePassword('edit-password')">ğŸ‘ï¸</button>
      </div>

      <label>Rolle</label>
      <select id="edit-role">
        <option value="mitarbeiter">Mitarbeiter</option>
        <option value="vorgesetzter">Vorgesetzter</option>
          <option value="planer">Planer</option>
      </select>

      <label>34a</label>
      <select id="edit-s34a">
        <option value="nein">Nein</option>
        <option value="ja">Ja</option>
      </select>

      <label>34a Art</label>
      <select id="edit-s34a_art">
        <option value="">--</option>
        <option value="unterrichtung">Unterrichtung</option>
        <option value="sachkunde">Sachkunde</option>
      </select>

      <label>P-Schein</label>
      <select id="edit-pschein">
        <option value="nein">Nein</option>
        <option value="ja">Ja</option>
      </select>

      <label>Bewach-ID</label>
      <input type="text" id="edit-bewach-id">

      <label>Steuernummer</label>
      <input type="text" id="edit-steuernummer">

      <label>BSW</label>
      <select id="edit-bsw">
        <option value="nein">Nein</option>
        <option value="ja">Ja</option>
      </select>

      <label>SanitÃ¤ter</label>
      <select id="edit-sanitaeter">
        <option value="nein">Nein</option>
        <option value="ja">Ja</option>
      </select>

      <label>Stundensatz (â‚¬/h)</label>
      <input type="number" id="edit-stundensatz" step="0.01" min="0">

      <div class="modal-actions">
        <button class="confirm" onclick="saveUserEdit()">ğŸ’¾ Speichern</button>
      </div>
    </div>
  </div>

  <!-- Modal: Mitarbeiter-Report-Details -->
  <div class="modal" id="userReportModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeUserReportModal()">Ã—</span>
      <h3>EinsÃ¤tze von <span id="report-username"></span></h3>

      <table class="user-table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Titel</th>
            <th>Ort</th>
            <th>Start</th>
            <th>Ende</th>
            <th>Stunden</th>
            <th>Stundensatz</th>
            <th>Kosten</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="user-report-details"></tbody>
        <tfoot>
          <tr class="tfoot-sum">
            <td colspan="4">Summe</td>
            <td id="user-report-sum-hours">0.00 h</td>
            <td></td>
            <td id="user-report-sum-cost">0.00 â‚¬</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="muted" style="margin-top:8px;">
        Hinweis: Hier kannst du im Report Zeiten und Stundensatz anpassen.
      </div>
    </div>
  </div>

  <!-- âœ… Modal: Endzeit Ã¤ndern (aus Report) -->
  <div class="modal" id="reportEndEditModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeReportEndEditModal()">Ã—</span>
      <h3>Endzeit Ã¤ndern</h3>

      <input type="hidden" id="rep-event-id">
      <input type="hidden" id="rep-username">

      <div class="detail-box"><b>Mitarbeiter:</b> <span id="rep-user-label"></span></div>
      <div class="detail-box"><b>Einsatz:</b> <span id="rep-title-label"></span></div>

      <label>Startzeit (optional)</label>
      <input type="time" id="rep-start-time">

      <label>Endzeit (HH:MM)</label>
      <input type="time" id="rep-end-time">

      <label>Stundensatz (optional, Ã¼berschreibt)</label>
      <input type="text" id="rep-rate" inputmode="decimal" placeholder="z.B. 20,00">

      <label>Bemerkung (optional)</label>
      <input type="text" id="rep-remark" placeholder="optional">

      <div class="modal-actions">
        <button class="confirm" onclick="saveReportEndTime()">ğŸ’¾ Speichern</button>
      </div>
    </div>
  </div>

  
  
  <!-- âœ… Modal: Planung â€“ Zeiten fÃ¼r alle bestÃ¤tigten Mitarbeiter -->
  <div class="modal" id="planningBulkEditModal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closePlanningBulkEditModal()">Ã—</span>
      <h3>Zeiten & Bemerkungen (Planung)</h3>

      <input type="hidden" id="plan-bulk-event-id">

      <div class="detail-box">
        <b>Einsatz:</b> <span id="plan-bulk-title"></span><br>
        <span class="muted">Doppelklick auf einen Einsatzblock Ã¶ffnet dieses Fenster.</span>
      </div>

      <div id="plan-bulk-list"></div>

      <div class="modal-actions" style="margin-top:10px;">
        <button class="confirm" onclick="savePlanningBulkEdits()">ğŸ’¾ Speichern</button>
        <button class="reject" onclick="closePlanningBulkEditModal()">Abbrechen</button>
      </div>
    </div>
  </div>


  <!-- âœ… Modal: Planung â€“ Planer sieht nur Kommentare (Doppelklick) -->
  <div class="modal" id="planningCommentsModal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closePlanningCommentsModal()">Ã—</span>
      <h3>Kommentare (Planung)</h3>

      <input type="hidden" id="plan-cmt-event-id">

      <div class="detail-box">
        <b>Einsatz:</b> <span id="plan-cmt-title"></span><br>
        <span class="muted">Doppelklick auf einen Einsatzblock zeigt hier nur die Kommentare der bestÃ¤tigten Mitarbeiter.</span>
      </div>

      <div id="plan-cmt-list"></div>

      <div class="modal-actions" style="margin-top:10px;">
        <button class="confirm" type="button" onclick="closePlanningCommentsModal()">SchlieÃŸen</button>
      </div>
    </div>
  </div>


  <!-- âœ… Modal: Einsatz duplizieren (Kalender) -->
  <div class="modal" id="duplicateModal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeDuplicateModal()">Ã—</span>
      <h3>Einsatz duplizieren</h3>

      <label>Einsatz auswÃ¤hlen</label>
      <select id="dup-source-event"></select>

      <div class="detail-box">
        <b>Mehrere Daten auswÃ¤hlen</b>
        <div class="muted">Tipp: Datum wÃ¤hlen â†’ â€HinzufÃ¼genâ€œ. Du kannst mehrere Tage sammeln.</div>

        <div class="form-row" style="align-items:flex-end;">
          <div>
            <label>Datum</label>
            <input type="date" id="dup-date">
          </div>
          <div style="flex:0;">
            <button class="confirm" type="button" onclick="addDupDate()">â• HinzufÃ¼gen</button>
          </div>
        </div>

        <div class="muted" style="margin-top:8px;">AusgewÃ¤hlte Daten:</div>
        <ul id="dup-date-list" style="margin:6px 0 0 18px;"></ul>

      </div>

      <div class="modal-actions">
        <button class="confirm" type="button" onclick="runDuplicate()">ğŸ“„ Duplizieren</button>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js">
    /* REPORT_SORT_BY_DATE */
    function fmtDateOnlyDE(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }
    
</script>
  <script>
    const ROLE = "{{ role|default('chef') }}";
    let calendar, planningCalendar, selectedDate=null, lastClickTime=0, currentEventId=null;
    let usersCache = {};
    let usersList = [];
    let currentEditUser = null;

    function setActiveTab(activeId){
      const ids = ["tab-calendar","tab-termine","tab-planning","tab-users","tab-report","tab-counter"];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(id === activeId) el.classList.add("active");
        else el.classList.remove("active");
      });
    }


    function hideTermine(){
      const t = document.getElementById("termine");
      if(t) t.style.display = "none";
    }

    const userByUsername = () => {
      const map = {};
      usersList.forEach(u => map[u.username] = u);
      return map;
    };

    function toggleEventRateInputs(which){
      if(which === 'create'){
        const use = document.getElementById("use-event-rate").checked;
        const rate = document.getElementById("event-rate");
        rate.disabled = !use;
        if(!use) rate.value = "";
      } else {
        const use = document.getElementById("edit-use-event-rate").checked;
        const rate = document.getElementById("edit-ev-rate");
        rate.disabled = !use;
        if(!use) rate.value = "";
      }
    }

    function toDateTimeLocalValue(d){
      const pad = n => String(n).padStart(2,'0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function fmtNumDE(n, digits=2){
      const v = Number(n);
      if(isNaN(v)) return "0,00";
      return v.toLocaleString('de-DE', { minimumFractionDigits: digits, maximumFractionDigits: digits });
    }

    // âœ… Zahl aus deutschem Format lesen (z.B. "20,50" oder "20.50" oder "1.234,56")
    function parseDeNumber(raw){
      if(raw === null || raw === undefined) return null;
      let t = String(raw).trim();
      if(t === "") return null;
      // Tausenderpunkte entfernen, Komma als Dezimalpunkt
      t = t.replace(/\./g, "").replace(/,/g, ".");
      const v = Number(t);
      return isNaN(v) ? null : v;
    }


    // âœ… Tooltip-Helfer (fÃ¼r title="...") â€“ verhindert kaputtes HTML bei AnfÃ¼hrungszeichen etc.
    function escapeAttr(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }


    function capYesNo(v){
      const t = String(v||"").toLowerCase();
      if(t === "ja") return "Ja";
      if(t === "nein") return "Nein";
      return v || "";
    }

    function fmtTimeOnly(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    // =========================
    // ğŸ—“ï¸ Meine Termine (Chef)
    // =========================
    function stripTitleTime(t){
      const s = String(t || "").trim();
      return s.replace(/\s*\(\d{2}:\d{2}\)\s*$/,"").trim();
    }

    function fmtDateDE(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }

    function fmtDateTimeDE(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      return `${fmtDateDE(d)} ${fmtTimeOnly(d)}`;
    }

    function fmtHHMM(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    async function loadMyTermine(){
      const me = "{{ user }}";
      const monthEl = document.getElementById("termine-month");
      const yearEl  = document.getElementById("termine-year");
      const selMonth = Number(monthEl?.value || 0);
      const selYear  = Number(yearEl?.value || 0);

      const tbody = document.getElementById("termine-list");
      const countEl = document.getElementById("termine-count");
      if(!tbody) return;

      tbody.innerHTML = "";
      if(countEl) countEl.textContent = "Ladeâ€¦";

      let res = await fetch("/events?ts="+Date.now());
      let events = await res.json();

      // nur bestÃ¤tigte fÃ¼r mich
      let rows = [];
      events.forEach(ev=>{
        const r = ev.responses?.[me] || null;
        if(!r || String(r.status||"").trim() !== "bestÃ¤tigt") return;

        const d = new Date(ev.start);
        if(!isNaN(d) && selMonth && selYear){
          const m = d.getMonth()+1;
          const y = d.getFullYear();
          if(m !== selMonth || y !== selYear) return;
        }

        const startLabel = (r.start_time && String(r.start_time).trim()) ? String(r.start_time).trim() : fmtHHMM(ev.start);
        const endLabel = (r.end_time && String(r.end_time).trim())
          ? String(r.end_time).trim()
          : (ev.planned_end_time && String(ev.planned_end_time).trim() ? String(ev.planned_end_time).trim() : "-");

        rows.push({
          date: fmtDateDE(ev.start),
          title: stripTitleTime(ev.title),
          ort: ev.ort || "-",
          start: startLabel || "-",
          end: endLabel || "-",
          remark: (r.remark || "").trim()
        });
      });

      // sort by date asc
      rows.sort((a,b)=> String(a.date).localeCompare(String(b.date), "de"));

      rows.forEach(x=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.date}</td>
          <td>${x.title || "-"}</td>
          <td>${x.ort}</td>
          <td>${x.start}</td>
          <td>${x.end}</td>
          <td style="white-space:normal;">${x.remark || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      if(countEl) countEl.textContent = `${rows.length} Termine`;
    }


    // Report Jahres-Input
    let yearInput = document.getElementById("report-year");
    let now = new Date();
    yearInput.value = now.getFullYear();
    yearInput.addEventListener("change", loadReport);

    // ZÃ¤hler Jahres-Input
    let counterYearInput = document.getElementById("counter-year");
    if(counterYearInput){
      counterYearInput.value = now.getFullYear();
      counterYearInput.addEventListener("change", loadCounter);
    }


    document.addEventListener('DOMContentLoaded', async function() {
      if(ROLE !== 'planer'){
        let resUsers = await fetch("/users");
        let users = await resUsers.json();
        usersList = users;
        users.forEach(u=>{ usersCache[u.username] = `${u.vorname} ${u.nachname}`; });
      } else {
        // âœ… Planer darf nur Namen sehen (ohne sensible Felder)
        let resUsers = await fetch("/users_public");
        let users = await resUsers.json();
        usersList = users;
        users.forEach(u=>{ usersCache[u.username] = `${u.vorname} ${u.nachname}`; });
      }

      toggleEventRateInputs('create');

      // Meine Termine: Default Monat/Jahr + Filter-Listener
      const nowT = new Date();
      const tMonth = document.getElementById("termine-month");
      const tYear  = document.getElementById("termine-year");
      if(tMonth && tYear){
        tMonth.value = String(nowT.getMonth()+1);
        tYear.value  = String(nowT.getFullYear());
        tMonth.addEventListener("change", loadMyTermine);
        tYear.addEventListener("change", loadMyTermine);
      }


      // Tabs
      if(ROLE !== 'planer'){
      document.getElementById("tab-calendar").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="block";
        document.getElementById("planning").style.display="none";
        hideTermine();
document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="none";
        setActiveTab("tab-calendar");
        window.location.reload();
      };

      // ğŸ—“ï¸ Meine Termine (Chef)
      document.getElementById("tab-termine").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        document.getElementById("termine").style.display="block";
        document.getElementById("planning").style.display="none";
document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="none";
        setActiveTab("tab-termine");
        loadMyTermine();
      };

      }

      if(ROLE !== 'planer'){
            document.getElementById("tab-users").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        hideTermine();
document.getElementById("planning").style.display="none";
        hideTermine();
document.getElementById("user-management").style.display="block";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="none";
        setActiveTab("tab-users");
        loadUsers();
      };
      document.getElementById("tab-report").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        hideTermine();
document.getElementById("planning").style.display="none";
        hideTermine();
document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="block";
        document.getElementById("counter").style.display="none";
        setActiveTab("tab-report");
        loadReport();
      };

      document.getElementById("tab-counter").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        hideTermine();
document.getElementById("planning").style.display="none";
        hideTermine();
document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="block";
        setActiveTab("tab-counter");
        loadCounter();
      };

      }

      document.getElementById("tab-planning").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        hideTermine();
document.getElementById("planning").style.display="block";
        document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="none";
        setActiveTab("tab-planning");
        // Planung initialisieren (einmalig) + aktualisieren
        if(!planningCalendar){ initPlanningCalendar(); }
        planningCalendar.refetchEvents();
      };

      if(ROLE === 'planer'){
        // Nur Planung sichtbar
        setActiveTab("tab-planning");
        document.getElementById("calendar").style.display="none";
        hideTermine();
document.getElementById("planning").style.display="block";
        document.getElementById("user-management").style.display="none";
        document.getElementById("report").style.display="none";
        document.getElementById("counter").style.display="none";
        if(!planningCalendar){ initPlanningCalendar(); }
        planningCalendar.refetchEvents();
      }


      // Kalender
      if(ROLE !== 'planer'){
      calendar=new FullCalendar.Calendar(document.getElementById('calendar'),{
        initialView:'dayGridMonth',
        locale:'de',
        firstDay: 1,
        height:"85vh",

        dayCellClassNames: (arg)=>{
          const dow = arg.date.getDay();
          return (dow===0 || dow===6) ? ['weekend'] : [];
        },

        customButtons: {
          duplicateBtn: {
            text: "ğŸ“„ Duplizieren",
            click: () => openDuplicateModal()
          }
        },
        headerToolbar: {
          left: "prev,next today duplicateBtn",
          center: "title",
          right: "dayGridMonth,dayGridWeek"
        },
        selectable:true,

        eventDisplay: "list-item",
        displayEventTime: true,
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

        dateClick: info => {
          let nowTs=new Date().getTime();
          if(nowTs-lastClickTime < 300){
            selectedDate=info.dateStr;
            openEventModal();
          }
          lastClickTime=nowTs;
        },
        eventClick: info => openDetailsModal(info.event),
        events: async (info,success)=>{
          let res=await fetch("/events");
          let events=await res.json();

          // âœ… Titel zeigt IMMER Event.start (bleibt unverÃ¤ndert, egal was du pro Mitarbeiter setzt)
          events.forEach(ev=>{
            if(ev.start){
              const d = new Date(ev.start);
              if(!isNaN(d)){
                const hh = String(d.getHours()).padStart(2,'0');
                const mm = String(d.getMinutes()).padStart(2,'0');
                const base = (ev.title || "").trim();
                ev.title = `${base} (${hh}:${mm})`.trim();
              }
            }

            if(ev.status==="geplant"){
              ev.color="gray"; ev.textColor="gray";
            }

            if(ev.status==="offen"){
              let confirmedCount = Object.values(ev.responses || {}).filter(r => r.status==="bestÃ¤tigt").length;
              const c = (confirmedCount >= (ev.required_staff || 0)) ? "green" : "darkblue";
              ev.color = c; ev.textColor = c;
            }
          });

          success(events);
        }
      });
      calendar.render();
      }

      // ===== Planung-Kalender =====
      // Baut HTML fÃ¼r bestÃ¤tigte Mitarbeiterliste.
      // âœ… Neu:
      // - Kevin (username "kevin") wird in der Planung magenta dargestellt.
      // - Jeder Name erhÃ¤lt data-username, damit wir per Doppelklick Zeiten bearbeiten kÃ¶nnen.
      function buildStaffList(ev){
        const responses = ev.responses || {};
        const items = [];

        // âœ… Planer: Zeiten nur ab HEUTE (inkl.) anzeigen â€“ Vergangenheit ohne Start/Ende
        const isPlaner = (typeof ROLE !== 'undefined' && ROLE === 'planer');
        let showTimes = true;
        if(isPlaner){
          const today = new Date();
          today.setHours(0,0,0,0);
          const evDate = new Date(ev.start || '');
          if(!isNaN(evDate)){
            evDate.setHours(0,0,0,0);
            if(evDate.getTime() < today.getTime()) showTimes = false;
          }
        }

        // Basis-Startzeit (Uhrzeit) des Einsatzes
        let baseStart = "-";
        if(ev.start){
          const d = new Date(ev.start);
          if(!isNaN(d)){
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            baseStart = `${hh}:${mm}`;
          }
        }

        for(const username in responses){
          const r = responses[username] || {};
          if(String(r.status || "").trim() === "bestÃ¤tigt"){
            const name = usersCache[username] || username;

            // Startzeit: Chef-Startzeit (response.start_time) hat PrioritÃ¤t, sonst Event-Start
            const st = (r.start_time && String(r.start_time).trim()) ? String(r.start_time).trim() : baseStart;

            // Endzeit: kommt vom Mitarbeiter (response.end_time) â€“ falls vorhanden, anzeigen
            const et = (r.end_time && String(r.end_time).trim()) ? String(r.end_time).trim() : "";

            // âœ… Zeile grÃ¼n markieren, wenn Start UND Ende eingetragen sind (pro Mitarbeiter)
                        // âœ… Zeile grÃ¼n markieren, wenn Ende gesetzt ist und ein Start existiert (entweder eigener Start oder Einsatz-Start)
            const hasStart = ((r.start_time && String(r.start_time).trim()) || (baseStart && baseStart !== "-"));
            const hasEnd = (r.end_time && String(r.end_time).trim());
            const done = hasStart && hasEnd;

            // Anzeige: (Start) oder (Startâ€“Ende)
            const times = et ? `${st}â€“${et}` : st;

            // âœ… Kevin (username "kevin") magenta
            const isKevin = String(username).toLowerCase() === "kevin";
            const remark = (r.remark || "").trim();
            // âœ… Hover: Bemerkung als Tooltip (nur wenn vorhanden)
            const tip = remark ? ` title="${escapeAttr(remark)}"` : "";
            const nameHtml = `<span class="plan-staff-user" data-username="${username}"${tip} style="cursor:pointer;${isKevin ? "color:magenta;font-weight:700;" : ""}">${name}</span>`;
            const rowClass = `plan-staff-row${(showTimes && done) ? " done" : ""}`;

            if(showTimes){
              items.push(`<div class="${rowClass}">${nameHtml}<br><span class="plan-staff-times">(${times})</span></div>`);
            } else {
              // Planer + Vergangenheit: nur Name (keine Zeiten)
              items.push(`<div class="plan-staff-row">${nameHtml}</div>`);
            }
          }
        }

        // Sortiert fÃ¼r Ordnung (ohne HTML-Tags als grobe Ordnung)
        items.sort((a,b)=>a.replace(/<[^>]*>/g,'').localeCompare(b.replace(/<[^>]*>/g,''), "de"));
        if(items.length === 0) return "â€”";

        // âœ… Planer-Ansicht: alle bestÃ¤tigten anzeigen
        return items.join("");
      }


      function initPlanningCalendar(){
        planningCalendar = new FullCalendar.Calendar(document.getElementById('planning-calendar'),{
          headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
          initialView:'dayGridWeek',
          locale:'de',
          firstDay: 1,
          height:"85vh",

        dayCellClassNames: (arg)=>{
          const dow = arg.date.getDay();
          return (dow===0 || dow===6) ? ['weekend'] : [];
        },
          selectable:false,
          eventDisplay: "block",
          displayEventTime: false,          dayHeaderContent: (arg) => {
            const d = arg.date;
            const dd = String(d.getDate()).padStart(2,'0');
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const wd = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
            return { html: `<b>${wd}., ${dd}.${mm}.</b>` };
          },
          dayMaxEventRows: true,

          events: async (info,success)=>{
            let res=await fetch("/events");
            let events=await res.json();

            // FÃ¼r Planung: keine Titel-Uhrzeit-Anreicherung wie im Hauptkalender,
            // stattdessen Titel + Mitarbeiterliste im Event-Block.
            events.forEach(ev=>{
              // Nur Tage mit EinsÃ¤tzen anzeigen (alle Status)
              const staff = buildStaffList(ev);
              ev._plan_staff = staff;
            });

            success(events);
          },

          eventContent: (arg)=>{
            const ev = arg.event.extendedProps || {};
            const title = (arg.event.title || "").replace(/\s*\(\d{2}:\d{2}\)\s*$/, "");
            const staff = (ev._plan_staff !== undefined) ? ev._plan_staff : "â€”";
            const wrap = document.createElement("div");
            wrap.innerHTML = `
              <div class="plan-title">${title || "(ohne Titel)"}</div>
              <div class="plan-staff">${staff}</div>
            `;
            return { domNodes: [wrap] };
          },

          // âœ… Planung: Doppelklick auf einen Einsatzblock
          // - Chef/Vorgesetzter: Zeiten/Kommentare fÃ¼r ALLE bestÃ¤tigten bearbeiten
          // - Planer: NUR Kommentare sehen
          eventDidMount: (info)=>{
            info.el.addEventListener('dblclick', (e)=>{
              e.preventDefault();
              e.stopPropagation();

              const props = info.event.extendedProps || {};
              const event_id = (props.id || info.event.id);
              const title = (info.event.title || props.title || "(ohne Titel)");

              if(ROLE === 'planer'){
                // Toggle: Doppelklick auf denselben Block schlieÃŸt
                const modal = document.getElementById('planningCommentsModal');
                const curId = (document.getElementById('plan-cmt-event-id')?.value || '');
                if(modal && modal.style.display === 'flex' && String(curId) === String(event_id)){
                  closePlanningCommentsModal();
                  return;
                }
                openPlanningCommentsModal(event_id, title, props);
                return;
              }

              if(!(ROLE === 'vorgesetzter' || ROLE === 'chef')) return;

              // Toggle: Doppelklick auf denselben Block schlieÃŸt das Popup
              const modal = document.getElementById('planningBulkEditModal');
              const curId = (document.getElementById('plan-bulk-event-id')?.value || '');
              if(modal && modal.style.display === 'flex' && String(curId) === String(event_id)){
                closePlanningBulkEditModal();
                return;
              }
              openPlanningBulkEdit(event_id, title, props);
            });
          },

          eventClick: ()=>{ /* Planung: nur Ãœbersicht */ }
});
        planningCalendar.render();

        // Auto-Refresh (wenn sich was Ã¤ndert, wird es spÃ¤testens nach 20s aktualisiert)
        setInterval(()=>{ 
          if(document.getElementById("planning").style.display !== "none"){
            planningCalendar.refetchEvents();
          }
        }, 20000);
      }


      // User hinzufÃ¼gen
      if(ROLE !== 'planer'){
      document.getElementById("add-user-form").onsubmit=async e=>{
        e.preventDefault();
        let data={
          vorname:document.getElementById("vorname").value,
          nachname:document.getElementById("nachname").value,
          username:document.getElementById("new-username").value,
          password:document.getElementById("new-password").value,
          role:document.getElementById("new-role").value,
          s34a:document.getElementById("s34a").value,
          s34a_art:document.getElementById("s34a_art").value,
          pschein:document.getElementById("pschein").value,
          bewach_id: document.getElementById("bewach_id").value,
          steuernummer: document.getElementById("steuernummer").value,
          bsw: document.getElementById("bsw").value,
          sanitaeter: document.getElementById("sanitaeter").value,
          stundensatz: document.getElementById("stundensatz").value
        };
        const resAdd = await fetch("/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
        const rAdd = await resAdd.json().catch(()=>({}));
        if(!resAdd.ok || rAdd.error){
          alert(rAdd.error || "HinzufÃ¼gen fehlgeschlagen");
          return;
        }
        loadUsers();
        e.target.reset();
      };
      }
    });

    
    // ===== Duplizieren (Kalender-Header) =====
    let dupSelectedDates = [];

    function openDuplicateModal(){
      document.getElementById("duplicateModal").style.display = "flex";
      dupSelectedDates = [];
      document.getElementById("dup-date-list").innerHTML = "";
document.getElementById("dup-date").value = "";

      // EinsÃ¤tze laden (aktuell im Kalender) â€“ wir nutzen /events
      loadDuplicateSourceOptions();
      renderDupDateList();
    }

    function closeDuplicateModal(){
      document.getElementById("duplicateModal").style.display = "none";
    }

    async function loadDuplicateSourceOptions(){
      const sel = document.getElementById("dup-source-event");
      sel.innerHTML = "<option value=''>Ladeâ€¦</option>";

      const res = await fetch("/events");
      const events = await res.json();

      // sort: Datum absteigend
      events.sort((a,b)=> String(b.start||"").localeCompare(String(a.start||"")) );

      sel.innerHTML = "";
      events.forEach(ev=>{
        const opt = document.createElement("option");
        opt.value = ev.id;
        const startTxt = ev.start ? fmtDateTimeDE(ev.start) : "";
        opt.textContent = `${ev.title || "(ohne Titel)"} â€“ ${startTxt}`;
        sel.appendChild(opt);
      });

      if(events.length === 0){
        sel.innerHTML = "<option value=''>Keine EinsÃ¤tze vorhanden</option>";
      }
    }

    function addDupDate(){
      const d = (document.getElementById("dup-date").value || "").trim();
      if(!d){ alert("Bitte ein Datum auswÃ¤hlen."); return; }
      if(!/^\d{4}-\d{2}-\d{2}$/.test(d)){ alert("UngÃ¼ltiges Datum."); return; }
      if(!dupSelectedDates.includes(d)) dupSelectedDates.push(d);
      renderDupDateList();
    }

    function removeDupDate(d){
      dupSelectedDates = dupSelectedDates.filter(x=>x!==d);
      renderDupDateList();
    }

    function renderDupDateList(){
      dupSelectedDates.sort();
      const ul = document.getElementById("dup-date-list");
      ul.innerHTML = "";
      dupSelectedDates.forEach(d=>{
        const li = document.createElement("li");
        li.innerHTML = `${d} <button class="reject inline" style="margin-left:8px;" type="button">Entfernen</button>`;
        li.querySelector("button").onclick = ()=>removeDupDate(d);
        ul.appendChild(li);
      });
      if(dupSelectedDates.length===0){
        ul.innerHTML = "<li class='muted'>â€”</li>";
      }
    }

    async function runDuplicate(){
      const event_id = (document.getElementById("dup-source-event").value || "").trim();
      if(!event_id){ alert("Bitte einen Einsatz auswÃ¤hlen."); return; }
if(!dupSelectedDates || dupSelectedDates.length === 0){
        alert("Bitte mindestens ein Datum auswÃ¤hlen.");
        return;
      }

      const res = await fetch("/events/duplicate", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ event_id, dates: dupSelectedDates })
      });

      const r = await res.json().catch(()=>({}));
      if(!res.ok || r.error){
        alert(r.error || "Duplizieren fehlgeschlagen");
        return;
      }

      closeDuplicateModal();
      if(calendar) calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }


    // Einsatz anlegen
    function openEventModal(){document.getElementById("eventModal").style.display="flex";}
    function closeEventModal(){document.getElementById("eventModal").style.display="none";}

    async function saveEvent(status){
      let time = document.getElementById("start-time").value;
      let start = selectedDate + "T" + time;

      const useEventRate = document.getElementById("use-event-rate").checked;

      let data={
        title:document.getElementById("title").value,
        ort:document.getElementById("ort").value,
        dienstkleidung:document.getElementById("dienst").value,
        auftraggeber:document.getElementById("auftrag").value,
        start:start,
        status:status,
        required_staff: document.getElementById("required-staff").value,
        planned_end_time: document.getElementById("planned-end-time").value,
        frist: document.getElementById("frist").value,
        use_event_rate: useEventRate ? 1 : 0,
        stundensatz: useEventRate ? document.getElementById("event-rate").value : ""
      };

      const res = await fetch("/events",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
      const r = await res.json().catch(()=>({}));
      if(!res.ok || r.error){
        alert(r.error || "Speichern fehlgeschlagen");
        return;
      }
      closeEventModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
      }

    // Details
    function openDetailsModal(ev){
      currentEventId=ev.extendedProps.id || ev.id;
      buildDetailsModal(ev.extendedProps, ev);
      document.getElementById("detailsModal").style.display="flex";
    }
    function closeDetailsModal(){document.getElementById("detailsModal").style.display="none";}

    async function refreshDetailsModal() {
      let res = await fetch("/events");
      let events = await res.json();
      let e = events.find(x => x.id === currentEventId);
      if (e) buildDetailsModal(e, { title: e.title, start: new Date(e.start), id: e.id });
    }

    async function confirmResponse(user, decision) {
      await fetch("/events/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ event_id: currentEventId, username: user, decision })
      });
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    async function removeUserFromEvent(user){
      if(!confirm(`Soll ${usersCache[user] || user} wirklich aus dem Einsatz entfernt werden?`)) return;
      await fetch("/events/remove_user", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ event_id: currentEventId, username: user })
      });
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    async function assignReplacement(){
      const sel = document.getElementById("replacement-user");
      const user = sel.value;
      if(!user){ alert("Bitte eine Person auswÃ¤hlen."); return; }
      await fetch("/events/assign_user", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ event_id: currentEventId, username: user })
      });
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    async function duplicateEvent(id){
      if(!id) return;
      const res = await fetch('/events/duplicate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ event_id: id })
      });
      const r = await res.json().catch(()=>({}));
      if(!res.ok || r.error){
        alert(r.error || 'Duplizieren fehlgeschlagen');
        return;
      }
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    async function deleteEvent() {
      if (!currentEventId) return;
      if (!confirm("Soll dieser Einsatz wirklich gelÃ¶scht werden?")) return;
      await fetch("/events/" + currentEventId, { method: "DELETE" });
      closeDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    async function releaseEvent(id){
      await fetch("/events/release", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({event_id:id})
      });
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    // Einsatz bearbeiten
    function openEditEventModal(ev, props){
      const p = props || {};

      document.getElementById("edit-event-id").value = p.id || ev.id || currentEventId;
      const cleanTitle = (ev && ev.title) ? String(ev.title).replace(/\s*\(\d{2}:\d{2}\)\s*$/,"").trim() : "";
      document.getElementById("edit-ev-title").value = (p.title ?? cleanTitle ?? "");
      document.getElementById("edit-ev-ort").value = (p.ort ?? "");
      document.getElementById("edit-ev-dienst").value = (p.dienstkleidung ?? "");
      document.getElementById("edit-ev-auftrag").value = (p.auftraggeber ?? "");

      let startIso = "";
      if (typeof p.start === "string" && p.start.length >= 16) {
        startIso = p.start.slice(0,16);
      } else if (ev && ev.start instanceof Date && !isNaN(ev.start)) {
        startIso = toDateTimeLocalValue(ev.start);
      } else if (ev && typeof ev.start === "string" && ev.start.length >= 16) {
        startIso = ev.start.slice(0,16);
      }
      document.getElementById("edit-ev-start").value = startIso;

      // Frist (optional)
      let fristIso = "";
      if (typeof p.frist === "string" && p.frist.length >= 16) {
        fristIso = p.frist.slice(0,16);
      }
      document.getElementById("edit-ev-frist").value = fristIso;

      document.getElementById("edit-ev-planned-end").value = p.planned_end_time || "";
      document.getElementById("edit-ev-status").value = (p.status ?? "geplant");
      document.getElementById("edit-ev-required").value = (p.required_staff ?? 0);

      const useEventRate = (Number(p.use_event_rate ?? 1) === 1);
      document.getElementById("edit-use-event-rate").checked = useEventRate;
      document.getElementById("edit-ev-rate").value = useEventRate ? (p.stundensatz ?? "") : "";

      toggleEventRateInputs('edit');

      document.getElementById("editEventModal").style.display="flex";
    }

    function closeEditEventModal(){ document.getElementById("editEventModal").style.display="none"; }

    async function saveEventEdit(){
      const useEventRate = document.getElementById("edit-use-event-rate").checked;

      const payload = {
        event_id: document.getElementById("edit-event-id").value,
        title: document.getElementById("edit-ev-title").value,
        ort: document.getElementById("edit-ev-ort").value,
        dienstkleidung: document.getElementById("edit-ev-dienst").value,
        auftraggeber: document.getElementById("edit-ev-auftrag").value,
        start: document.getElementById("edit-ev-start").value,
        frist: document.getElementById("edit-ev-frist").value,
        planned_end_time: document.getElementById("edit-ev-planned-end").value,
        status: document.getElementById("edit-ev-status").value,
        required_staff: document.getElementById("edit-ev-required").value,
        use_event_rate: useEventRate ? 1 : 0,
        stundensatz: useEventRate ? document.getElementById("edit-ev-rate").value : ""
      };
      // âœ… Schutz: leere Pflichtfelder verhindern (sonst kann Einsatz "verschwinden")
      if(!payload.title || !payload.title.trim()){
        alert("Bitte einen Titel eingeben (darf nicht leer sein).");
        return;
      }
      if(!payload.start || String(payload.start).trim().length < 16){
        alert("Bitte ein Startdatum + Uhrzeit auswÃ¤hlen.");
        return;
      }


      await fetch("/events/update",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });

      closeEditEventModal();
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
    }

    // Zeiten pro Mitarbeiter
    function cancelTimeEdit(){
      document.getElementById("time-edit-box").style.display = "none";
      const rr = document.getElementById("time-remark"); if(rr) rr.value="";
    }

    function prepareTimeEdit(){
      const sel = document.getElementById("time-user-select");
      const user = sel.value;
      if(!user){ alert("Bitte Mitarbeiter auswÃ¤hlen."); return; }

      const r = (window._currentEventProps?.responses || {})[user] || {};
      document.getElementById("time-start").value  = r.start_time || "";
      document.getElementById("time-remark").value = r.remark || "";
      document.getElementById("time-edit-box").style.display = "block";
    }

    async function saveSelectedUserTimes(){
      const sel = document.getElementById("time-user-select");
      const user = sel.value;
      if(!user){ alert("Bitte Mitarbeiter auswÃ¤hlen."); return; }

      const start_time = document.getElementById("time-start").value;
      const remark = document.getElementById("time-remark").value || "";
      const res = await fetch("/events/edit_entry", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ event_id: currentEventId, username: user, start_time, remark })
      });

      if(!res.ok){
        const t = await res.text();
        alert("Speichern fehlgeschlagen: " + t);
        return;
      }

      cancelTimeEdit();
      await refreshDetailsModal();
      calendar.refetchEvents();
      if(planningCalendar) planningCalendar.refetchEvents();
      loadReport(); // falls Report offen
    }

    function buildDetailsModal(props, ev){
      const p = props || {};
      window._currentEventProps = p;

      document.getElementById("d-title").textContent = p.title || (ev && ev.title) || "-";
      document.getElementById("d-ort").textContent = p.ort || "-";
      document.getElementById("d-dienst").textContent = p.dienstkleidung || "-";
      document.getElementById("d-auftrag").textContent = p.auftraggeber || "-";

      // âœ… nur Uhrzeit vom Event.start
      document.getElementById("d-start").textContent = (p.start ? fmtTimeOnly(p.start) : (ev && ev.start ? fmtTimeOnly(ev.start) : "-"));

      document.getElementById("d-planned-end").textContent = p.planned_end_time || "-";

      // Frist anzeigen
      const fr = (p.frist || "").trim();
      if(fr){
        const fd = new Date(fr);
        document.getElementById("d-frist").textContent = isNaN(fd) ? fr : fmtDateTimeDE(fd);
      } else {
        document.getElementById("d-frist").textContent = "-";
      }
      document.getElementById("d-required").textContent = (p.required_staff ?? 0);

      const useEventRate = (Number(p.use_event_rate ?? 1) === 1);
      if(useEventRate){
        const rate = (p.stundensatz === "" || p.stundensatz === null || p.stundensatz === undefined)
          ? "-"
          : (fmtNumDE(Number(p.stundensatz),2) + " â‚¬/h");
        document.getElementById("d-rate-mode").textContent = `Einsatz-Stundensatz: ${rate}`;
      } else {
        document.getElementById("d-rate-mode").textContent = "Mitarbeiter-StundensÃ¤tze (aus Verwaltung)";
      }

      let actions=document.querySelector("#detailsModal .modal-actions");
      actions.innerHTML="";

      let del=document.createElement("button");
      del.className="delete";
      del.textContent="ğŸ—‘ï¸ Einsatz lÃ¶schen";
      del.onclick=()=>deleteEvent();
      actions.appendChild(del);

      let editBtn=document.createElement("button");
      editBtn.className="confirm";
      editBtn.textContent="âœï¸ Einsatz bearbeiten";
      editBtn.onclick=()=>openEditEventModal(ev, p);
      actions.appendChild(editBtn);

      if(p.status==="geplant"){
        let release=document.createElement("button");
        release.className="release";
        release.textContent="ğŸš€ Freigeben";
        release.onclick=()=>releaseEvent(p.id || ev.id);
        actions.appendChild(release);
      }

      // Antworten + Start/Ende neben Name (pro Mitarbeiter)
      let list=document.getElementById("response-list");
      list.innerHTML="";
      let confirmedNames=[];
      // Basis-Startzeit (Uhrzeit) des Einsatzes fÃ¼r Anzeige bei Mitarbeitenden ohne Chef-Startzeit
      let baseStartSource = p.start || (ev ? ev.start : null);
      let baseStartHHMM = "-";
      if(typeof baseStartSource === "string"){
        const s = baseStartSource.trim();
        const m = s.match(/^([0-9]{1,2}):([0-9]{2})$/);
        if(m){
          baseStartHHMM = String(m[1]).padStart(2,"0")+":"+m[2];
        } else {
          baseStartHHMM = fmtTimeOnly(s);
        }
      } else {
        baseStartHHMM = fmtTimeOnly(baseStartSource);
      }


      // âœ… Reihenfolge in Einsatzdetails:
// 1) bestÃ¤tigte hintereinander
// 2) alle anderen Status hintereinander (zugesagt/abgelehnt/entfernt/...)
// (Stabile Gruppierung â€“ keine unnÃ¶tige Um-Sortierung)
      const _respEntries = Object.entries(p.responses || {});
      const _best = [];
      const _other = [];

      for(const [user, r0] of _respEntries){
        const r = r0 || {};
        const stStatus = String(r.status || "").trim();
        // âœ… Wenn Mitarbeiter Zusage/Absage zurÃ¼ckzieht (status leer/NULL):
        // keine Karte anzeigen => keine Umrandung / kein leeres KÃ¤stchen.
        if(!stStatus) continue;

        if(stStatus === "bestÃ¤tigt") _best.push([user, r, stStatus]);
        else _other.push([user, r, stStatus]);
      }

      for(const [user, r, stStatus] of _best.concat(_other)){
        let fullname = usersCache[user] || user;

        const st = (r.start_time && String(r.start_time).trim()) ? r.start_time : baseStartHHMM;
        const en = (r.end_time && String(r.end_time).trim()) ? r.end_time : "";

        let timeLabel = "";
        if(st || en){
          timeLabel =
            ` <span style="font-weight:normal;color:#444;">(` +
            `Start: <b>${st || "-"}</b> | Ende: <b>${en || "-"}</b>` +
            `)</span>`;
        }

        let li=document.createElement("li");

        // status als Klasse setzen (z.B. abgelehnt_chef, entfernt_chef)
        li.classList.add(stStatus);

        if(stStatus==="zugesagt"){
          li.innerHTML=`<b>${fullname}</b>${timeLabel} âœ… Zugesagt ${r.remark?`<i>(${r.remark})</i>`:""}`;

          let btnYes=document.createElement("button");
          btnYes.textContent="âœ… BestÃ¤tigen"; btnYes.className="confirm inline"; btnYes.onclick=()=>confirmResponse(user,"bestÃ¤tigt");

          let btnNo=document.createElement("button");
          btnNo.textContent="âŒ Ablehnen"; btnNo.className="reject inline"; btnNo.onclick=()=>confirmResponse(user,"abgelehnt");

          li.appendChild(btnYes); li.appendChild(btnNo);

        } else if(stStatus==="bestÃ¤tigt"){
          li.innerHTML=`<b>${fullname}</b>${timeLabel} âœ… BestÃ¤tigt ${r.remark?`<i>(${r.remark})</i>`:""}`;
          confirmedNames.push(fullname);

          let btnRemove=document.createElement("button");
          btnRemove.textContent="ğŸ—‘ï¸ Entfernen";
          btnRemove.className="reject inline";
          btnRemove.onclick=()=>removeUserFromEvent(user);
          li.appendChild(btnRemove);

        } else if(stStatus==="abgelehnt" || stStatus==="abgelehnt_Vorgesetzter" || stStatus==="abgelehnt_chef"){
          li.innerHTML=`<b>${fullname}</b>${timeLabel} âŒ Abgelehnt ${r.remark?`<i>(${r.remark})</i>`:""}`;

        } else if(stStatus==="entfernt_Vorgesetzter" || stStatus==="entfernt_chef"){
          li.innerHTML=`<b>${fullname}</b>${timeLabel} ğŸ—‘ï¸ Entfernt ${r.remark?`<i>(${r.remark})</i>`:""}`;
        }

        // Nur anzeigen, wenn wir auch Inhalt gesetzt haben
        if(li.innerHTML && li.innerHTML.trim() !== ""){
          list.appendChild(li);
        }
      }
document.getElementById("confirmed-counter").textContent =
        "BestÃ¤tigt: "+confirmedNames.length+" / BenÃ¶tigt: "+(p.required_staff || 0);
      document.getElementById("confirmed-counter").title = confirmedNames.join(", ");

      // Replacement
      const replacementSelect = document.getElementById("replacement-user");
      replacementSelect.innerHTML = "";

      const candidates = usersList;

      candidates.forEach(u=>{
        const opt=document.createElement("option");
        opt.value=u.username;
        const resp = (p.responses||{})[u.username] || null;
        let label = `${u.vorname} ${u.nachname}`;
        if(resp && resp.status){ label += ` (${resp.status})`; }
        opt.textContent = label;
        replacementSelect.appendChild(opt);
      });

      if(candidates.length===0){
        const opt=document.createElement("option");
        opt.value="";
        opt.textContent="Keine verfÃ¼gbaren Kandidaten";
        replacementSelect.appendChild(opt);
      }

      // Dropdown Zeiten: nur bestÃ¤tigte
      const timeSel = document.getElementById("time-user-select");
      timeSel.innerHTML = "";

      const confirmedUsers = Object.entries(p.responses || {})
        .filter(([u, r]) => r.status === "bestÃ¤tigt")
        .map(([u]) => u);

      if(confirmedUsers.length === 0){
        const opt=document.createElement("option");
        opt.value="";
        opt.textContent="Keine bestÃ¤tigten Mitarbeiter";
        timeSel.appendChild(opt);
        cancelTimeEdit();
      } else {
        confirmedUsers.forEach(u=>{
          const opt=document.createElement("option");
          opt.value=u;
          opt.textContent=usersCache[u] || u;
          timeSel.appendChild(opt);
        });
      }
    }

    // User Management
    async function loadUsers(){
      let res=await fetch("/users");
      let users=await res.json();

      // âœ… Alphabetisch nach Benutzername (Aâ€“Z)
      users.sort((a,b)=> String(a.username||"").localeCompare(String(b.username||""), "de"));

      usersList = users;
      usersCache = {};
      users.forEach(u=>{ usersCache[u.username] = `${u.vorname} ${u.nachname}`; });

      let list=document.getElementById("user-list");
      list.innerHTML="";
      users.forEach(u=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`
          <td><b>${u.username}</b></td>
          <td>${u.vorname} ${u.nachname}</td>
          <td>${capYesNo(u.s34a)}${String(u.s34a||'').toLowerCase()==="ja" ? " ("+(u.s34a_art||"")+")" : ""}</td>
          <td>${u.bewach_id || "-"}</td>
          <td>${u.steuernummer || "-"}</td>
          <td>${capYesNo(u.bsw || "nein")}</td>
          <td>${capYesNo(u.sanitaeter || "nein")}</td>
          <td>${capYesNo(u.pschein || "nein")}</td>
          <td>${(u.stundensatz!=="" && u.stundensatz!==null && u.stundensatz!==undefined) ? (fmtNumDE(Number(u.stundensatz),2) + " â‚¬/h") : "-"}</td>
          <td>
            <button class="confirm" onclick='openEditModal(${JSON.stringify(u)})'>âœï¸ Bearbeiten</button>
            <button class="reject" onclick="deleteUser('${u.username}')">âŒ LÃ¶schen</button>
          </td>
        `;
        list.appendChild(tr);
      });



      // âœ… Summenzeile (alle Mitarbeiter zusammen) aktualisieren
      function updateReportSumRow(){
        const monthHours = Array(12).fill(0);
        const monthCost  = Array(12).fill(0);
        let totalHours = 0;
        let totalCost  = 0;

        usersList.forEach(u=>{
          const username = u.username;
          const d = reportData[username];
          if(!d) return;
          for(let mi=0; mi<12; mi++){
            const md = d.months[mi];
            monthHours[mi] += Number(md.hours || 0);
            monthCost[mi]  += Number(md.cost  || 0);
          }
          totalHours += Number(d.totalHours || 0);
          totalCost  += Number(d.totalCost  || 0);
        });

        const ids = ["rpt-sum-jan","rpt-sum-feb","rpt-sum-mar","rpt-sum-apr","rpt-sum-mai","rpt-sum-jun",
                     "rpt-sum-jul","rpt-sum-aug","rpt-sum-sep","rpt-sum-okt","rpt-sum-nov","rpt-sum-dez"];
        ids.forEach((id,i)=>{
          const el = document.getElementById(id);
          if(!el) return;
          const h = monthHours[i];
          const c = monthCost[i];
          if(!h && !c){
            el.innerHTML = `<span class="muted">-</span>`;
          } else {
            el.innerHTML = `<div><b>${fmtNumDE(h,2)} h</b></div><div>${fmtNumDE(c,2)} â‚¬</div>`;
          }
        });

        const hEl = document.getElementById("rpt-sum-hours");
        if(hEl) hEl.innerHTML = `<b>${fmtNumDE(totalHours,2)} h</b>`;
        const cEl = document.getElementById("rpt-sum-cost");
        if(cEl) cEl.innerHTML = `<b>${fmtNumDE(totalCost,2)} â‚¬</b>`;
      }

      updateReportSumRow();
    }

    async function deleteUser(username){
      await fetch("/users/"+username,{method:"DELETE"});
      loadUsers();
    }

    function openEditModal(user){
      document.getElementById("edit-username").value=user.username;
      currentEditUser = user.username;

      document.getElementById("edit-vorname").value=user.vorname || "";
      document.getElementById("edit-nachname").value=user.nachname || "";
      document.getElementById("edit-password").value=user.password||"";
      document.getElementById("edit-role").value=user.role || "mitarbeiter";
      document.getElementById("edit-s34a").value=user.s34a || "nein";
      document.getElementById("edit-s34a_art").value=user.s34a_art || "";
      document.getElementById("edit-pschein").value=user.pschein || "nein";

      document.getElementById("edit-bewach-id").value=user.bewach_id || "";
      document.getElementById("edit-steuernummer").value=user.steuernummer || "";
      document.getElementById("edit-bsw").value=user.bsw || "nein";
      document.getElementById("edit-sanitaeter").value=user.sanitaeter || "nein";

      document.getElementById("edit-stundensatz").value=(user.stundensatz ?? "") === "" ? "" : Number(user.stundensatz);
      document.getElementById("editUserModal").style.display="flex";
    }

    function closeEditModal(){ document.getElementById("editUserModal").style.display="none"; }

    async function saveUserEdit(){
      const oldUsername = currentEditUser;
      const newUsernameRaw = document.getElementById("edit-username").value.trim();
      const newUsername = newUsernameRaw; // Anzeige
      const newUsernameUrl = encodeURIComponent(newUsernameRaw); // âœ… fÃ¼r URL

      if(!newUsernameRaw){ alert("Benutzername darf nicht leer sein."); return; }

      // 1) ggf. umbenennen
      if(oldUsername !== newUsernameRaw){
        const resRename = await fetch("/users/rename", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ old_username: oldUsername, new_username: newUsernameRaw })
        });
        const rRename = await resRename.json().catch(()=>({error:"UngÃ¼ltige Server-Antwort"}));
        if(!resRename.ok || rRename.error){
          alert(rRename.error || "Umbenennen fehlgeschlagen");
          return;
        }
        // âœ… wichtig: internen Edit-User aktualisieren
        currentEditUser = newUsernameRaw;
      }

      // 2) Daten speichern
      let data={
        vorname:document.getElementById("edit-vorname").value,
        nachname:document.getElementById("edit-nachname").value,
        password:(document.getElementById("edit-password").value || "").trim() ? document.getElementById("edit-password").value : null,
        role:document.getElementById("edit-role").value,
        s34a:document.getElementById("edit-s34a").value,
        s34a_art:document.getElementById("edit-s34a_art").value,
        pschein:document.getElementById("edit-pschein").value,
        bewach_id: document.getElementById("edit-bewach-id").value,
        steuernummer: document.getElementById("edit-steuernummer").value,
        bsw: document.getElementById("edit-bsw").value,
        sanitaeter: document.getElementById("edit-sanitaeter").value,
        stundensatz:document.getElementById("edit-stundensatz").value
      };

      const resSave = await fetch("/users/"+newUsernameUrl,{
        method:"PUT", headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
      });

      const rSave = await resSave.json().catch(()=>({}));
      if(!resSave.ok || rSave.error){
        alert(rSave.error || "Speichern fehlgeschlagen");
        return;
      }

      closeEditModal();

      // âœ… sicher aktualisieren (Tabelle + Cache)
      await loadUsers();

      // optional: Kalender/Planung aktualisieren, falls Namen/Stundensatz geÃ¤ndert wurden
      if(typeof calendar !== "undefined" && calendar) calendar.refetchEvents();
      if(typeof planningCalendar !== "undefined" && planningCalendar) planningCalendar.refetchEvents();
    }

    function togglePassword(id){
      let input=document.getElementById(id);
      input.type=input.type==="password"?"text":"password";
    }

    // âœ… Hilfsfunktion: Endzeit kann am nÃ¤chsten Tag liegen (z.B. 22:00â€“06:00)
    function calcEndAndHours(startDate, endTimeStr){
      if(!startDate || isNaN(startDate)) return { end: null, hours: 0 };

      const eParts = String(endTimeStr || "").split(":");
      if(eParts.length < 2) return { end: null, hours: 0 };

      const eh = Number(eParts[0]); const em = Number(eParts[1]);
      if(isNaN(eh) || isNaN(em)) return { end: null, hours: 0 };

      const end = new Date(startDate);
      end.setHours(eh, em, 0, 0);

      // Wenn Endzeit "frÃ¼her" ist als Startzeit -> nÃ¤chster Tag
      if(end.getTime() < startDate.getTime()){
        end.setDate(end.getDate() + 1);
      }

      let hours = (end - startDate) / (1000*60*60);
      if(!isFinite(hours) || hours < 0) hours = 0;

      return { end, hours };
    }

    // REPORT laden + Endzeit-Edit Aktion
    
    // REPORT laden (JahresÃ¼bersicht: Janâ€“Dez)
    async function loadReport(){
      // Users + Cache
      let ures = await fetch("/users");
      usersList = await ures.json();
      const uMap = userByUsername();
      usersCache = {};
      usersList.forEach(u=>{ usersCache[u.username] = `${u.vorname} ${u.nachname}`; });

      // Jahr
      const yRaw = (document.getElementById("report-year")?.value || "").trim();
      const year = yRaw ? parseInt(yRaw, 10) : (new Date()).getFullYear();

      let res = await fetch("/events");
      let events = await res.json();

      const monthNames = ["Januar","Februar","MÃ¤rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];

      // username -> { months: [{hours,cost,details:[]}], totalHours, totalCost }
      let reportData = {};

      function ensureUser(username){
        if(!reportData[username]){
          reportData[username] = {
            months: Array.from({length:12}, ()=>({hours:0, cost:0, details:[]})),
            totalHours: 0,
            totalCost: 0
          };
        }
        return reportData[username];
      }

      events.forEach(ev=>{
        if(!ev || !ev.start) return;
        const baseStart = new Date(ev.start);
        if(isNaN(baseStart)) return;

        // Filter: nur dieses Jahr
        if(baseStart.getFullYear() !== year) return;
        const monthIdx = baseStart.getMonth(); // 0..11

        for (let user in (ev.responses || {})) {
          const r = ev.responses[user];
          if(!r) continue;

          if (r.status === "bestÃ¤tigt" && r.end_time) {
            // Startzeit: Event.start + ggf. Chef Startzeit pro Mitarbeiter
            let startDate = new Date(baseStart);
            if(r.start_time){
              const parts = String(r.start_time).split(":");
              if(parts.length >= 2){
                const sh = Number(parts[0]); const sm = Number(parts[1]);
                if(!isNaN(sh) && !isNaN(sm)) startDate.setHours(sh, sm, 0, 0);
              }
            }

            // Endzeit
            const eParts = String(r.end_time).split(":");
            if(eParts.length < 2) continue;
            const eh = Number(eParts[0]); const em = Number(eParts[1]);
            if(isNaN(eh) || isNaN(em)) continue;

            const calc = calcEndAndHours(startDate, r.end_time);
            const end = calc.end;
            let hours = calc.hours;

            const useEventRate = Number(ev.use_event_rate ?? 1) === 1;
            let rate = 0;

            // âœ… manuelle Ãœberschreibung aus Report/Details (response.rate_override)
            if(r.rate_override !== undefined && r.rate_override !== null && String(r.rate_override) !== ""){
              rate = Number(r.rate_override);
              if(isNaN(rate)) rate = 0;
            } else if(useEventRate){
              rate = Number(ev.stundensatz ?? 0);
              if (isNaN(rate)) rate = 0;
            } else {
              const u = uMap[user];
              rate = Number(u?.stundensatz ?? 0);
              if (isNaN(rate)) rate = 0;
            }

            const cost = hours * rate;

            const bucket = ensureUser(user);
            bucket.months[monthIdx].hours += hours;
            bucket.months[monthIdx].cost  += cost;
            bucket.months[monthIdx].details.push({
              ev: ev,
              hours: hours,
              start_time: r.start_time || "",
              end_time: r.end_time,
              remark: r.remark,
              rate: rate,
              rate_override: (r.rate_override ?? ""),
              cost: cost,
              year: year,
              monthIdx: monthIdx
            });

            bucket.totalHours += hours;
            bucket.totalCost  += cost;
          }
        }
      });

      // Render
      let list = document.getElementById("report-list");
      list.innerHTML = "";

      // Reihenfolge: wie User-Liste
      usersList.forEach(u=>{
        const username = u.username;
        const d = reportData[username];
        if(!d) return;

        const tr = document.createElement("tr");

        // Name
        const tdName = document.createElement("td");
        tdName.textContent = usersCache[username] || username;
        tr.appendChild(tdName);

        // Monate
        for(let mi=0; mi<12; mi++){
          const md = d.months[mi];
          const td = document.createElement("td");
          td.style.cursor = "pointer";

          if(md.details.length === 0){
            td.innerHTML = `<span class="muted">-</span>`;
          } else {
            td.innerHTML = `<div><b>${fmtNumDE(md.hours,2)} h</b></div><div>${fmtNumDE(md.cost,2)} â‚¬</div>`;
          }

          td.ondblclick = ()=>{
            if(md.details.length === 0){
              alert(`Keine EinsÃ¤tze fÃ¼r ${usersCache[username] || username} im ${monthNames[mi]} ${year}.`);
              return;
            }
            openUserReport(username, md.details, { year, monthIdx: mi, monthName: monthNames[mi] });
          };

          tr.appendChild(td);
        }

        // Totals
        const tdH = document.createElement("td");
        tdH.innerHTML = `<b>${fmtNumDE(d.totalHours,2)} h</b>`;
        tr.appendChild(tdH);

        const tdC = document.createElement("td");
        tdC.innerHTML = `<b>${fmtNumDE(d.totalCost,2)} â‚¬</b>`;
        tr.appendChild(tdC);

        list.appendChild(tr);
      });



      // âœ… Summenzeile (alle Mitarbeiter zusammen) aktualisieren
      function updateReportSumRow(){
        const monthHours = Array(12).fill(0);
        const monthCosts = Array(12).fill(0);
        let totalHours = 0;
        let totalCost = 0;

        // Summen aus den berechneten Daten (nicht aus HTML)
        usersList.forEach(u=>{
          const username = u.username;
          const d = reportData[username];
          if(!d) return;
          for(let mi=0; mi<12; mi++){
            const md = d.months[mi];
            monthHours[mi] += Number(md.hours || 0);
            monthCosts[mi] += Number(md.cost || 0);
          }
          totalHours += Number(d.totalHours || 0);
          totalCost  += Number(d.totalCost || 0);
        });

        const map = [
          ['rpt-sum-jan',0],['rpt-sum-feb',1],['rpt-sum-mar',2],['rpt-sum-apr',3],['rpt-sum-mai',4],['rpt-sum-jun',5],
          ['rpt-sum-jul',6],['rpt-sum-aug',7],['rpt-sum-sep',8],['rpt-sum-okt',9],['rpt-sum-nov',10],['rpt-sum-dez',11]
        ];
        map.forEach(([id, idx])=>{
          const el = document.getElementById(id);
          if(!el) return;
          const h = monthHours[idx];
          const c = monthCosts[idx];
          if(!h && !c){
            el.innerHTML = `<span class="muted">-</span>`;
          } else {
            el.innerHTML = `<div><b>${fmtNumDE(h,2)} h</b></div><div>${fmtNumDE(c,2)} â‚¬</div>`;
          }
        });

        const hEl = document.getElementById('rpt-sum-hours');
        if(hEl) hEl.innerHTML = `<b>${fmtNumDE(totalHours,2)} h</b>`;
        const cEl = document.getElementById('rpt-sum-cost');
        if(cEl) cEl.innerHTML = `<b>${fmtNumDE(totalCost,2)} â‚¬</b>`;
      }

      updateReportSumRow();
    }

    
    // ZÃ„HLER laden (EinsÃ¤tze pro Mitarbeiter: Janâ€“Dez)
    async function loadCounter(){
      // Users + Cache
      let ures = await fetch("/users");
      usersList = await ures.json();
      usersCache = {};
      usersList.forEach(u=>{ usersCache[u.username] = `${u.vorname} ${u.nachname}`; });

      // Jahr
      const yRaw = (document.getElementById("counter-year")?.value || "").trim();
      const year = yRaw ? parseInt(yRaw, 10) : (new Date()).getFullYear();

      let res = await fetch("/events");
      let events = await res.json();

      // username -> { months:[12], total }
      let counterData = {};
      function ensureUser(username){
        if(!counterData[username]){
          counterData[username] = { months: Array.from({length:12}, ()=>0), total: 0 };
        }
        return counterData[username];
      }

      events.forEach(ev=>{
        if(!ev || !ev.start) return;
        const baseStart = new Date(ev.start);
        if(isNaN(baseStart)) return;

        if(baseStart.getFullYear() !== year) return;
        const monthIdx = baseStart.getMonth();

        for(const user in (ev.responses || {})){
          const r = ev.responses[user];
          if(!r) continue;
          if(String(r.status || "").trim() === "bestÃ¤tigt"){
            const bucket = ensureUser(user);
            bucket.months[monthIdx] += 1;
            bucket.total += 1;
          }
        }
      });

      // Render
      let list = document.getElementById("counter-list");
      list.innerHTML = "";

      // Reihenfolge: wie User-Liste
      usersList.forEach(u=>{
        const username = u.username;
        const d = counterData[username] || { months: Array.from({length:12}, ()=>0), total: 0 };

        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = usersCache[username] || username;
        tr.appendChild(tdName);

        for(let mi=0; mi<12; mi++){
          const td = document.createElement("td");
          const v = Number(d.months[mi] || 0);
          td.innerHTML = v ? `<b>${v}</b>` : `<span class="muted">-</span>`;
          tr.appendChild(td);
        }

        const tdT = document.createElement("td");
        tdT.innerHTML = `<b>${Number(d.total || 0)}</b>`;
        tr.appendChild(tdT);

        list.appendChild(tr);
      });

  // âœ… Summenzeile (alle Mitarbeiter zusammen) im ZÃ¤hler aktualisieren
  function updateCounterSumRow(){
    const monthSums = Array(12).fill(0);
    let yearSum = 0;

    // Summen aus den berechneten Daten (nicht aus HTML)
    usersList.forEach(u=>{
      const username = u.username;
      const d = counterData[username] || { months: Array.from({length:12}, ()=>0), total: 0 };
      for(let mi=0; mi<12; mi++){
        monthSums[mi] += Number(d.months[mi] || 0);
      }
      yearSum += Number(d.total || 0);
    });

    const ids = ["sum-jan","sum-feb","sum-mar","sum-apr","sum-mai","sum-jun",
                 "sum-jul","sum-aug","sum-sep","sum-okt","sum-nov","sum-dez"];
    ids.forEach((id,i)=>{
      const el = document.getElementById(id);
      if(el) el.textContent = monthSums[i];
    });
    const yel = document.getElementById("sum-year");
    if(yel) yel.textContent = yearSum;
  }

  updateCounterSumRow();
}
    function openUserReport(username, details, scope){

      const who = usersCache[username] || username;
      let head = who;
      if(scope && scope.monthName && scope.year){ head = `${who} â€“ ${scope.monthName} ${scope.year}`; }
      else if(scope && scope.year){ head = `${who} â€“ ${scope.year}`; }
      document.getElementById("report-username").textContent = head;
      let tbody=document.getElementById("user-report-details");
      tbody.innerHTML="";

      let sumHours = 0;
      let sumCost  = 0;

      // âœ… Immer nach Datum (Start) sortieren â€“ damit die Liste im Report bei Doppelklick
      // sauber nach Datum geordnet ist.
      details.sort((a,b)=>{
        const sa = new Date(a?.ev?.start || 0).getTime();
        const sb = new Date(b?.ev?.start || 0).getTime();
        if(sa !== sb) return sa - sb;

        // Falls gleicher Tag: nach Startzeit (pro Mitarbeiter) sortieren
        const ta = (a?.start_time || '').trim();
        const tb = (b?.start_time || '').trim();
        return ta.localeCompare(tb, 'de');
      });

      details.forEach(d=>{
        let ev=d.ev;

        let start = new Date(ev.start);
        if(d.start_time){
          let [sh, sm] = d.start_time.split(":");
          start.setHours(Number(sh), Number(sm), 0, 0);
        }

        let calc = calcEndAndHours(start, d.end_time);
        let end = calc.end;

        const endLabel = end ? ((end.toDateString() !== start.toDateString())
          ? fmtDateTimeDE(end)
          : fmtTimeOnly(end)) : "-";

        sumHours += d.hours;
        sumCost  += d.cost;

        let tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${fmtDateOnlyDE(start)}</td>
          <td>${ev.title}</td>
          <td>${ev.ort || "-"}</td>
          <td>${fmtTimeOnly(start)}</td>
          <td>${endLabel}</td>
          <td>${fmtNumDE(d.hours,2)} h</td>
          <td>${fmtNumDE(d.rate,2)} â‚¬/h</td>
          <td>${fmtNumDE(d.cost,2)} â‚¬</td>
          <td><button class="confirm">âœï¸ Bearbeiten</button></td>
        `;
        tr.querySelector("button").onclick = ()=>openReportEndEdit(username, ev, d.start_time, d.end_time, d.remark, d.rate_override);
        tbody.appendChild(tr);
      });

      document.getElementById("user-report-sum-hours").textContent = `${fmtNumDE(sumHours,2)} h`;
      document.getElementById("user-report-sum-cost").textContent  = `${fmtNumDE(sumCost,2)} â‚¬`;

      document.getElementById("userReportModal").style.display="flex";
    }

    function closeUserReportModal(){document.getElementById("userReportModal").style.display="none";}

    // Report Endzeit Ã¤ndern
    function openReportEndEdit(username, ev, startTime, endTime, remark, rateOverride){
      document.getElementById("rep-event-id").value = ev.id;
      document.getElementById("rep-username").value = username;
      document.getElementById("rep-user-label").textContent = usersCache[username] || username;
      document.getElementById("rep-title-label").textContent = ev.title || "(ohne Titel)";
      document.getElementById("rep-start-time").value = startTime || "";
      document.getElementById("rep-end-time").value = endTime || "";
      document.getElementById("rep-rate").value = (rateOverride !== undefined && rateOverride !== null && String(rateOverride) !== "") ? fmtNumDE(Number(rateOverride),2) : "";
      document.getElementById("rep-remark").value = remark || "";
      document.getElementById("reportEndEditModal").style.display="flex";
    }
    function closeReportEndEditModal(){ document.getElementById("reportEndEditModal").style.display="none"; }

    async function saveReportEndTime(){
      const event_id = document.getElementById("rep-event-id").value;
      const username = document.getElementById("rep-username").value;
      const start_time = document.getElementById("rep-start-time").value;
      const end_time = document.getElementById("rep-end-time").value;

      const rate_raw = (document.getElementById("rep-rate").value || "").trim();
      const remark   = document.getElementById("rep-remark").value || "";

      // âœ… Stundensatz: Komma oder Punkt akzeptieren
      let rate_override = null;
      if(rate_raw !== ""){
        const parsed = parseDeNumber(rate_raw);
        if(parsed === null){
          alert("Stundensatz ungÃ¼ltig. Bitte z.B. 20,00 eingeben.");
          return;
        }
        rate_override = parsed;
      }

      const res = await fetch("/events/edit_entry", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ event_id, username, start_time, end_time, rate_override, remark })
      });

      if(!res.ok){
        const t = await res.text();
        alert("Speichern fehlgeschlagen: " + t);
        return;
      }

      closeReportEndEditModal();

      // âœ… Report neu berechnen (damit â‚¬ sofort stimmen)
      await loadReport();

      // optional: Kalender/Planung aktualisieren
      if(typeof calendar !== "undefined" && calendar) calendar.refetchEvents();
      if(typeof planningCalendar !== "undefined" && planningCalendar) planningCalendar.refetchEvents();

      // Detail-Modal schlieÃŸen (User kann per Doppelklick sofort wieder Ã¶ffnen)
      closeUserReportModal();
    }

    // =========================
    // ğŸ—‚ï¸ Planung: Bulk-Zeiten bearbeiten (fÃ¼r alle bestÃ¤tigten)
    // =========================
    function openPlanningBulkEdit(event_id, title, props){
      document.getElementById("plan-bulk-event-id").value = event_id || "";
      document.getElementById("plan-bulk-title").textContent = (title || "").replace(/\s*\(\d{2}:\d{2}\)\s*$/,"").trim();

      const list = document.getElementById("plan-bulk-list");
      list.innerHTML = "";

      const responses = (props && props.responses) ? props.responses : {};
      const baseStart = props && props.start ? fmtTimeOnly(props.start) : "-";

      const confirmed = [];
      for(const username in responses){
        const r = responses[username] || {};
        if(String(r.status || "").trim() === "bestÃ¤tigt"){
          confirmed.push({ username, r });
        }
      }

      confirmed.sort((a,b)=>{
        const an = (usersCache[a.username] || a.username);
        const bn = (usersCache[b.username] || b.username);
        return an.localeCompare(bn, "de");
      });

      if(confirmed.length === 0){
        list.innerHTML = `<div class="muted">Keine bestÃ¤tigten Mitarbeiter.</div>`;
      } else {
        confirmed.forEach((x)=>{
          const username = x.username;
          const r = x.r || {};
          const name = usersCache[username] || username;

          const st = (r.start_time && String(r.start_time).trim()) ? String(r.start_time).trim() : (baseStart && baseStart !== "-" ? baseStart : "");
          const et = (r.end_time && String(r.end_time).trim()) ? String(r.end_time).trim() : "";
          const rm = (r.remark || "").trim();

          const row = document.createElement("div");
          row.className = "detail-box";
          row.style.marginBottom = "10px";
          row.innerHTML = `
            <div style="font-weight:700;margin-bottom:6px;">${name}</div>
            <div class="form-row">
              <div>
                <label>Start</label>
                <input type="time" class="plan-bulk-start" data-username="${username}" value="${st}">
              </div>
              <div>
                <label>Ende</label>
                <input type="time" class="plan-bulk-end" data-username="${username}" value="${et}">
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Bemerkung</label>
                <input type="text" class="plan-bulk-remark" data-username="${username}" value="${rm}" placeholder="optional">
              </div>
            </div>
            <div style="border-top:1px dashed #ddd;margin-top:8px;"></div>
          `;
          list.appendChild(row);
        });
      }

      document.getElementById("planningBulkEditModal").style.display = "flex";
    }

    function closePlanningBulkEditModal(){
      document.getElementById("planningBulkEditModal").style.display = "none";
    }


    // =========================
    // ğŸ—‚ï¸ Planung (Planer): nur Kommentare anzeigen
    // =========================
    function openPlanningCommentsModal(event_id, title, props){
      document.getElementById("plan-cmt-event-id").value = event_id || "";
      document.getElementById("plan-cmt-title").textContent = (title || "").replace(/\s*\(\d{2}:\d{2}\)\s*$/,"").trim();

      const list = document.getElementById("plan-cmt-list");
      list.innerHTML = "";

      const responses = (props && props.responses) ? props.responses : {};

      const confirmedWithComments = [];
      for(const username in responses){
        const r = responses[username] || {};
        if(String(r.status || "").trim() !== "bestÃ¤tigt") continue;
        const remark = (r.remark || "").trim();
        if(!remark) continue;
        confirmedWithComments.push({ username, remark });
      }

      confirmedWithComments.sort((a,b)=>{
        const an = (usersCache[a.username] || a.username);
        const bn = (usersCache[b.username] || b.username);
        return an.localeCompare(bn, "de");
      });

      if(confirmedWithComments.length === 0){
        list.innerHTML = `<div class="muted">Keine Kommentare vorhanden.</div>`;
      } else {
        confirmedWithComments.forEach(x=>{
          const name = usersCache[x.username] || x.username;
          const box = document.createElement("div");
          box.className = "detail-box";
          box.style.marginBottom = "10px";
          box.innerHTML = `
            <div style="font-weight:700;margin-bottom:6px;">${name}</div>
            <div style="white-space:pre-wrap;">${escapeAttr(x.remark).replace(/\n/g,"<br>")}</div>
          `;
          list.appendChild(box);
        });
      }

      document.getElementById("planningCommentsModal").style.display = "flex";
    }

    function closePlanningCommentsModal(){
      document.getElementById("planningCommentsModal").style.display = "none";
    }

    async function savePlanningBulkEdits(){
      const event_id = document.getElementById("plan-bulk-event-id").value;
      if(!event_id){ alert("Kein Einsatz gewÃ¤hlt."); return; }

      const starts = Array.from(document.querySelectorAll(".plan-bulk-start"));
      const ends   = Array.from(document.querySelectorAll(".plan-bulk-end"));
      const remarks= Array.from(document.querySelectorAll(".plan-bulk-remark"));

      const byUser = {};
      starts.forEach(i=>{
        const u = i.getAttribute("data-username");
        if(!byUser[u]) byUser[u] = {};
        byUser[u].start_time = (i.value || "").trim();
      });
      ends.forEach(i=>{
        const u = i.getAttribute("data-username");
        if(!byUser[u]) byUser[u] = {};
        byUser[u].end_time = (i.value || "").trim();
      });
      remarks.forEach(i=>{
        const u = i.getAttribute("data-username");
        if(!byUser[u]) byUser[u] = {};
        byUser[u].remark = (i.value || "");
      });

      const users = Object.keys(byUser);

      for(const u of users){
        const payload = {
          event_id,
          username: u,
          start_time: (byUser[u].start_time || ""),
          remark: (byUser[u].remark || "")
        };
        const _et = (byUser[u].end_time || "").trim();
        if(_et) payload.end_time = _et;

        const res = await fetch("/events/edit_entry", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const t = await res.text();
          alert("Speichern fehlgeschlagen: " + t);
          return;
        }
      }

      closePlanningBulkEditModal();

      if(typeof calendar !== "undefined" && calendar) calendar.refetchEvents();
      if(typeof planningCalendar !== "undefined" && planningCalendar) planningCalendar.refetchEvents();
      if(typeof loadReport === "function") loadReport();
    }

  
    /* REPORT_SORT_BY_DATE */
    function fmtDateOnlyDE(dt){
      const d = new Date(dt);
      if(isNaN(d)) return "-";
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }
    
</script>
</body>
</html>
