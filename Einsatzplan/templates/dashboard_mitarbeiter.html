<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Mitarbeiter Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .fc-daygrid-event-dot{
      height:16px;width:16px;border-radius:50%;
      background-color:transparent;
      margin-right:8px;
      border:3px solid currentColor;
    }
    .fc-event-title{font-weight:bold;font-size:14px;}
    .detail-box{
      border:1px solid #ddd;border-radius:6px;padding:8px;
      margin-bottom:10px;background:#fafafa;
    }
    .filter-row{margin:10px 0;}
    .earnings-bold{font-weight:bold;color:#1a1a1a;}
    .muted{color:#666;font-size:12px;margin-top:6px;}
  
    /* Einheitliche Buttons in Einsatzdetails */
    .modal-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .modal-actions button{
      flex:1;
      min-width:160px;
      padding:10px 12px;
      border-radius:10px;
      font-size:14px;
      line-height:1.1;
    }
    
  
    #endtime-section{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    #endtime-section input[type="time"]{
      flex:1;
      min-width:160px;
    }
    #btn-endtime{
      min-width:160px;
      padding:10px 12px;
      border-radius:10px;
      font-size:14px;
    }

  </style>
</head>
<body>
  <nav>
    <div class="left">
      <a href="#" id="tab-calendar" class="active">üìÖ Kalender</a>
      <a href="#" id="tab-report">üìä Report</a>
    </div>
    <div class="right">
      <span>{{ user }}</span>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <div id="calendar"></div>

  <div id="report" style="display:none;">
    <div class="filter-row">
      <label for="report-month">Monat w√§hlen:</label>
      <input type="month" id="report-month">
    </div>

    <h4 id="report-total">Gesamtstunden: 0 h | Gesamtverdienst: 0.00 ‚Ç¨</h4>

    <table class="user-table">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Titel</th>
          <th>Start</th>
          <th>Vorauss. Ende</th>
          <th>Ende</th>
          <th>Stunden</th>
          <th>Stundensatz</th>
          <th>Verdienst</th>
        </tr>
      </thead>
      <tbody id="report-list"></tbody>
    </table>
  </div>

  <div class="modal" id="respondModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeRespondModal()">√ó</span>
      <h3 id="r-title">Einsatzdetails</h3>

      <div class="detail-box"><b>Ort:</b> <span id="r-ort"></span></div>
      <div class="detail-box"><b>Dienstkleidung:</b> <span id="r-dienst"></span></div>
      <div class="detail-box"><b>Mitteilung:</b> <span id="r-auftrag"></span></div>

      <div class="detail-box"><b>Start:</b> <span id="r-start"></span></div>
      <div class="detail-box"><b>Voraussichtliches Ende:</b> <span id="r-planned-end"></span></div>
      <div class="detail-box"><b>Frist:</b> <span id="r-frist"></span></div>

      <div class="detail-box"><b>Stundensatz:</b> <span id="r-rate"></span></div>

      <div id="remark-block" style="margin-top:10px;">
        <label for="r-remark">Bemerkung (optional)</label>
        <textarea id="r-remark" rows="3" placeholder="Bemerkung..."></textarea>
      </div>

      <div id="endtime-section" style="margin-top:10px; display:none;">
        <input type="time" id="r-endtime">
        <button class="confirm" id="btn-endtime">üíæ Endzeit speichern</button>
        <div id="saved-endtime" style="margin-top:6px; font-weight:bold; display:none;"></div>
      </div>

      <div class="modal-actions" id="response-buttons">
        <button class="confirm" id="btn-zusagen">‚úÖ Zusagen</button>
        <button class="reject" id="btn-absagen">‚ùå Absagen</button>
        <button class="release" id="btn-withdraw">‚Ü©Ô∏è Zur√ºckziehen</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script>
    let calendar, currentEventId=null;

    function fmtTime(d){
      if(!(d instanceof Date) || isNaN(d)) return "-";
      return d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
    }

    function normTime(t){
      // erwartet "HH:MM" oder leer
      const s = String(t || "").trim();
      const m = s.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return "";
      const hh = String(Math.min(23, Math.max(0, Number(m[1])))).padStart(2,"0");
      const mm = String(Math.min(59, Math.max(0, Number(m[2])))).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function fmtRate(n){
      const v = Number(n);
      if(isNaN(v)) return "-";
      return v.toFixed(2) + " ‚Ç¨/h";
    }

    // ‚úÖ my_rate kommt vom Backend und ist IMMER der richtige Satz (Einsatz oder Profil)
    function getMyRate(ev){
      const me = "{{ user }}";
      const r = ev.responses?.[me] || null;

      // ‚úÖ Chef-Override pro Einsatz hat Priorit√§t
      if(r && r.rate_override !== undefined && r.rate_override !== null && String(r.rate_override).trim() !== ""){
        const ov = Number(r.rate_override);
        return isNaN(ov) ? 0 : ov;
      }

      const v = Number(ev.my_rate ?? 0);
      return isNaN(v) ? 0 : v;
    }

    function rateLabel(ev, myResponse){
      // Wenn Override gesetzt wurde, immer so anzeigen
      if(myResponse && myResponse.rate_override !== undefined && myResponse.rate_override !== null && String(myResponse.rate_override).trim() !== ""){
        const ov = Number(myResponse.rate_override);
        return fmtRate(ov) + " (√ºberschrieben)";
      }

      const base = fmtRate(getMyRate(ev));
      const useEventRate = Number(ev.use_event_rate ?? 1) === 1;
      return useEventRate ? base : (base + " (Profil)");
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("tab-calendar").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="block";
        document.getElementById("report").style.display="none";
        e.target.classList.add("active");
        document.getElementById("tab-report").classList.remove("active");
        window.location.reload();
      };

      document.getElementById("tab-report").onclick = e=>{
        e.preventDefault();
        document.getElementById("calendar").style.display="none";
        document.getElementById("report").style.display="block";
        e.target.classList.add("active");
        document.getElementById("tab-calendar").classList.remove("active");

        let now=new Date();
        document.getElementById("report-month").value =
          now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");

        loadReport();
      };

      document.getElementById("report-month").addEventListener("change", loadReport);

      calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: "dayGridMonth",
        locale: "de",
        firstDay: 1,
        height: "85vh",

        // Dot-Modus damit die Kreise sichtbar bleiben
        eventDisplay: "list-item",
        displayEventTime: false,

        eventClick: function(info) {
          currentEventId = info.event.extendedProps.id || info.event.id;
          const ev = info.event.extendedProps || {};
          const me = "{{ user }}";
          const myResponse = ev.responses?.[me] || null;

          // Kopf/Felder
          document.getElementById("r-title").textContent = info.event.title || "(ohne Titel)";
          document.getElementById("r-ort").textContent = ev.ort || "-";
          document.getElementById("r-dienst").textContent = ev.dienstkleidung || "-";
          document.getElementById("r-auftrag").textContent = ev.auftraggeber || "-";
          document.getElementById("r-planned-end").textContent = ev.planned_end_time || "-";

          // Frist
          const frRaw = String(ev.frist || "").trim();
          let fristExpired = false;
          if(frRaw){
            const fd = new Date(frRaw);
            document.getElementById("r-frist").textContent = isNaN(fd) ? frRaw : fd.toLocaleString("de-DE");
            if(!isNaN(fd) && new Date() > fd) fristExpired = true;
          } else {
            document.getElementById("r-frist").textContent = "-";
          }

          // Startanzeige: Chef-Startzeit (response.start_time) hat Priorit√§t
          const chefStart = normTime(myResponse?.start_time);
          document.getElementById("r-start").textContent = chefStart || fmtTime(info.event.start);

          // Stundensatz
          document.getElementById("r-rate").textContent = rateLabel(ev, myResponse);

          // Remark / Buttons
          const remarkBlock = document.getElementById("remark-block");
          const remarkInput = document.getElementById("r-remark");
          const btnBox = document.getElementById("response-buttons");
          const btnWithdraw = document.getElementById("btn-withdraw");

          const status = myResponse?.status || "";
          const remarkVal = (myResponse?.remark || "").trim();

          const canAct = !fristExpired && status !== "best√§tigt";

          // Remark initial
          remarkInput.value = remarkVal || "";
          remarkInput.disabled = !canAct;

          // Buttons Sichtbarkeit
          if(!canAct){
            btnBox.style.display = "none";
            // Remark nur zeigen, wenn es was gibt (oder wenn best√§tigt und Endzeit fehlt etc.)
            remarkBlock.style.display = remarkVal ? "block" : "none";
          } else {
            btnBox.style.display = "flex";
            remarkBlock.style.display = "block";
            // Zur√ºckziehen nur, wenn bereits reagiert wurde
            btnWithdraw.style.display = status ? "inline-block" : "none";
          }

          // Endzeit-Bereich nur wenn best√§tigt
          const section = document.getElementById("endtime-section");
          const input = document.getElementById("r-endtime");
          const btn = document.getElementById("btn-endtime");
          const saved = document.getElementById("saved-endtime");

          if (status === "best√§tigt") {
            section.style.display = "block";
            if (myResponse?.end_time) {
              input.style.display = "none";
              btn.style.display = "none";
              saved.style.display = "block";
              saved.textContent = "Gespeicherte Endzeit: " + myResponse.end_time;
            } else {
              input.style.display = "block";
              btn.style.display = "inline-block";
              saved.style.display = "none";
            }
          } else {
            section.style.display = "none";
          }

          document.getElementById("respondModal").style.display = "flex";
        },

        events: async (info, success) => {
          let res = await fetch("/events?ts="+Date.now());
          let events = await res.json();

          // Sichtbarkeit nach Frist:
// - status==geplant nie zeigen
// - abgelehnt nie zeigen
// - wenn Frist vorbei UND Mitarbeiter nichts gemacht hat -> ausblenden
// - wenn Frist vorbei UND Mitarbeiter abgelehnt hat -> ausblenden
// - zugesagt/best√§tigt bleibt sichtbar
          const me = "{{ user }}";
          events = events.filter(e => {
            const my = e.responses?.[me] || null;
            const st = String(my?.status || "").trim();

            if (e.status === "geplant") return false;

            // ‚úÖ Chef-Entscheidung: sofort ausblenden
            if (["abgelehnt_chef","entfernt_chef"].includes(st)) return false;

            const frRaw = String(e.frist || "").trim();
            let fristExpired = false;
            if(frRaw){
              const fd = new Date(frRaw);
              if(!isNaN(fd) && new Date() > fd) fristExpired = true;
            }

            // ‚úÖ Mitarbeiter hat selbst abgesagt:
            // -> bis zur Frist als roter Kreis sichtbar
            // -> nach Frist automatisch ausblenden
            if (st === "abgelehnt") {
              if(!frRaw) return false;        // ohne Frist nicht anzeigen
              if(fristExpired) return false;  // nach Frist weg
              return true;                    // vor Frist sichtbar (rot)
            }

            // Sichtbarkeit nach Frist:
            // - wenn Frist vorbei UND Mitarbeiter nichts gemacht hat -> ausblenden
            // - zugesagt/best√§tigt bleibt sichtbar
            if(fristExpired){
              if(!st) return false;
            }
            return true;
          });

          events.forEach(ev => {
            let my = ev.responses?.["{{ user }}"];
            const st = String(my?.status || "").trim();
            if (st === "zugesagt") ev.color = "orange";
            if (st === "best√§tigt") ev.color = "green";
            // ‚úÖ Chef-Ablehnung/Entfernen ebenfalls rot anzeigen, falls sichtbar
            if (["abgelehnt","abgelehnt_chef","entfernt_chef"].includes(st)) ev.color = "red";

          });

          success(events);
        }
      });

      calendar.render();

            document.getElementById("btn-zusagen").onclick = () => sendResponse("zugesagt");
      document.getElementById("btn-absagen").onclick = () => sendResponse("abgelehnt");
      document.getElementById("btn-withdraw").onclick = () => withdrawResponse();

      document.getElementById("btn-endtime").onclick = async () => {
        let endtime = document.getElementById("r-endtime").value;
        if (!endtime) { alert("Bitte Endzeit eintragen!"); return; }

        await fetch("/events/endtime", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ event_id: currentEventId, username: "{{ user }}", end_time: endtime })
        });

        closeRespondModal();
        calendar.refetchEvents();
      };
    });

    function closeRespondModal() {
      document.getElementById("respondModal").style.display = "none";
    }

    async function sendResponse(status) {
      let remarkBlock = document.getElementById("remark-block");
      let remark = remarkBlock.style.display === "none" ? "" : document.getElementById("r-remark").value;

      const res = await fetch("/events/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ event_id: currentEventId, response: status, remark })
      });
      const r = await res.json().catch(()=>({}));
      if(!res.ok || r.error){ alert(r.error || "Aktion fehlgeschlagen"); }

      closeRespondModal();
      calendar.refetchEvents();
    }

    async function withdrawResponse(){
      const res = await fetch("/events/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ event_id: currentEventId, response: "", remark: "" })
      });
      const r = await res.json().catch(()=>({}));
      if(!res.ok || r.error){ alert(r.error || "Zur√ºckziehen fehlgeschlagen"); }

      closeRespondModal();
      calendar.refetchEvents();
    }

    // REPORT (‚úÖ rechnet mit my_rate UND ber√ºcksichtigt Chef-Startzeit)
    async function loadReport(){
      let month = document.getElementById("report-month").value;
      if(!month) return;

      let res = await fetch("/events?ts="+Date.now());
      let events = await res.json();

      let totalHours = 0;
      let totalEarnings = 0;
      let entries = [];

      events.forEach(ev=>{
        let r = ev.responses?.["{{ user }}"];

        if(r?.status==="best√§tigt" && r.end_time){
          let start = new Date(ev.start);

          // ‚úÖ Chef-Startzeit nutzen, wenn vorhanden
          if (r.start_time) {
            const parts = String(r.start_time).split(":");
            if (parts.length === 2) {
              const sh = Number(parts[0]);
              const sm = Number(parts[1]);
              if (!isNaN(sh) && !isNaN(sm)) start.setHours(sh, sm, 0, 0);
            }
          }

          let [eh,em] = r.end_time.split(":");
          let end = new Date(start); end.setHours(Number(eh), Number(em), 0, 0);

          // ‚úÖ Falls Einsatz √ºber Mitternacht geht (z.B. 22:00 -> 06:00), n√§chsten Tag ber√ºcksichtigen
          if(end < start){
            end.setDate(end.getDate() + 1);
          }

          let evMonth = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,"0")}`;
          if(evMonth!==month) return;

          let hours=(end-start)/(1000*60*60);
          if(hours<0) hours=0;

          const rate = getMyRate(ev);
          const earnings = hours * rate;

          totalHours += hours;
          totalEarnings += earnings;

          entries.push({
            date:start.toLocaleDateString("de-DE"),
            title:ev.title || "(ohne Titel)",
            startStr:start.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),
            plannedEnd: ev.planned_end_time || "-",
            endStr:end.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),
            hours, rate,
            rateText: (r && r.rate_override !== undefined && r.rate_override !== null && String(r.rate_override).trim() !== "") ? (fmtRate(rate) + " (√ºberschrieben)") : ((Number(ev.use_event_rate ?? 1) === 1) ? fmtRate(rate) : (fmtRate(rate) + " (Profil)")),
            earnings
          });
        }
      });

      entries.sort((a,b)=> a.date.localeCompare(b.date) || a.startStr.localeCompare(b.startStr));

      document.getElementById("report-total").textContent =
        "Gesamtstunden: " + totalHours.toFixed(2) +
        " h | Gesamtverdienst: " + totalEarnings.toFixed(2) + " ‚Ç¨";

      let list=document.getElementById("report-list");
      list.innerHTML="";

      entries.forEach(e=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${e.date}</td>
          <td>${e.title}</td>
          <td>${e.startStr}</td>
          <td>${e.plannedEnd}</td>
          <td>${e.endStr}</td>
          <td>${e.hours.toFixed(2)}</td>
          <td>${e.rateText}</td>
          <td class="earnings-bold">${e.earnings.toFixed(2)} ‚Ç¨</td>
        `;
        list.appendChild(tr);
      });
    }
  </script>
</body>
</html>
